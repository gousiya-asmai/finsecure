from django.core.mail import send_mail
from django.conf import settings
import threading
import logging

logger = logging.getLogger(__name__)

def send_fraud_alert_email(user_email, transaction_info, user_name=None):
    """
    Send fraud alert email asynchronously to prevent blocking
    
    Args:
        user_email (str): Recipient email address
        transaction_info (str): Formatted transaction details
        user_name (str, optional): User's name for personalization
    """
    def _send_email():
        try:
            subject = 'ğŸš¨ URGENT: Fraud Alert on Your Account - FinSecure'
            
            # Format the message
            message = f"""
Dear {user_name or 'Customer'},

âš ï¸ FRAUD ALERT - IMMEDIATE ATTENTION REQUIRED âš ï¸

We have detected a suspicious transaction on your FinSecure account:

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{transaction_info}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”’ WHAT YOU SHOULD DO NOW:

1. âœ… If you recognize this transaction - No action needed
2. âŒ If you DO NOT recognize this transaction:
   â€¢ Log in to your FinSecure account immediately
   â€¢ Review the transaction details
   â€¢ Report it as fraudulent
   â€¢ Contact your bank to block your card

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This alert was generated by our AI-powered fraud detection system.

For assistance, visit: https://finsecure-jgzx.onrender.com/assistance/dashboard/

Stay Safe,
FinSecure Security Team

---
This is an automated security alert. Please do not reply directly.
            """
            
            from_email = settings.DEFAULT_FROM_EMAIL
            recipient_list = [user_email]
            
            logger.info(f"ğŸ“§ Attempting to send fraud alert to {user_email}")
            
            # Send the email
            result = send_mail(
                subject=subject,
                message=message,
                from_email=from_email,
                recipient_list=recipient_list,
                fail_silently=False,
            )
            
            if result == 1:
                logger.info(f"âœ… Fraud alert email sent successfully to {user_email}")
            else:
                logger.warning(f"âš ï¸ Email send returned {result} for {user_email}")
                
        except Exception as e:
            logger.error(f"âŒ Fraud email failed for {user_email}: {str(e)}", exc_info=True)
    
    # Send email in background thread
    email_thread = threading.Thread(target=_send_email)
    email_thread.daemon = True
    email_thread.start()
    
    logger.info(f"ğŸš€ Fraud email thread started for {user_email}")
