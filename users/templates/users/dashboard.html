{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
        .profile-card {
            background: #fdf9ff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0px 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .profile-header img {
            border-radius: 50%;
            width: 70px;
            height: 70px;
            object-fit: cover;
            border: 3px solid #ddd;
        }
        .profile-details {
            margin-top: 15px;
        }
        .profile-details p {
            margin: 6px 0;
        }
body {
  background: linear-gradient(120deg, #ece4fc 15%, #bb8afd 92%);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
}
.sidebar-nav {
  position: fixed;
  top: 0; left: 0; bottom: 0;
  width: 230px;
  background: #a459c8;
  box-shadow: 2px 0 28px #c99fe0;
  z-index: 1100;
  display: flex;
  flex-direction: column;
}
.sidebar-brand {
  color: #ece4fc;
  font-weight: 700;
  font-size: 1.35rem;
  text-align: center;
  padding: 31px 0 14px 0;
  letter-spacing: .7px;
}
.sidebar-menu {
  flex: 1;
  margin-top: 28px;
}
.sidebar-menu a {
  display: flex;
  align-items: center;
  font-size: 1.09rem;
  font-weight: 500;
  color: #ece4fc;
  padding: 13px 32px 13px 28px;
  text-decoration: none;
  border-left: 5px solid transparent;
  transition: background .14s, color .14s, border-color .2s;
  margin-bottom: 1px;
  border-radius: 6px 0 0 6px;
}
.sidebar-menu a .bi {
  margin-right: 12px;
  font-size: 1.22em;
}
.sidebar-menu a:hover {
  background: #c992e0;
  color: #fffefb;
  border-left: 5px solid #d1a4ff;
}
.sidebar-menu a.active {
  background: #d4bbed !important;
  color: #7a4fff !important;
  border-left: 5px solid #7a4fff !important;
  font-weight: bold;
}
.sidebar-footer {
  text-align: center;
  padding: 16px;
  color: #e3caf7;
  font-size: 0.98rem;
  letter-spacing: .4px;
}

.main-content {
  margin-left: 240px;
  padding: 31px 32px 32px 32px;
  min-height: 100vh;
}

@media (max-width: 900px) {
  .sidebar-nav { width: 60px; }
  .sidebar-brand { font-size: 1.08rem; padding: 21px 0; }
  .sidebar-menu a { font-size: 0; padding: 12px 11px; }
  .sidebar-menu a .bi { font-size: 1.1rem; margin: 0; }
  .sidebar-menu a span { display: none; }
  .main-content { margin-left: 85px; padding: 18px 6px 12px 13px; }
}

.dashboard-header-card {
  max-width: 1000px;
  margin: 0 auto 30px auto;
  background: linear-gradient(135deg, #fff7ff 93%, #e4d1fb 100%);
  border-radius: 22px;
  box-shadow: 0 8px 38px #bb8afd14, 0 1px 12px #7a4fff10;
  padding: 28px;
}
.dashboard-header-card h2 {
  font-weight: 700;
  font-size: 1.58rem;
  color: #993fc7;
  margin-bottom: 10px;
}

.menu-header-bar {
  background: #b67ee6;
  color: #fff;
  border-radius: 0.9em;
  padding: 22px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 1.22rem;
  font-weight: bold;
  margin-bottom: 19px;
  margin-top: -10px;
}
.menu-header-title {
  font-size: 1.18rem;
  font-weight: bold;
  letter-spacing: .2px;
}
.menu-header-right a {
  color: #fff;
  font-size: 1.07rem;
  font-weight: 600;
  background: none;
  border: none;
  text-decoration: underline;
  margin-left: 9px;
}

/* Card backgrounds and headers in purple shades */
.dashboard-card {
  background: linear-gradient(135deg, #fff7ff 97%, #e4d1fb 100%);
  border-radius: 17px;
  box-shadow: 0 8px 22px #bb8afd14, 0 1px 10px #7a4fff10;
  padding: 21px 24px 19px 24px;
  margin-bottom: 22px;
}
.dashboard-card h3 {
  color: #993fc7; font-weight:600; margin-bottom:18px;
}
/* Purples for header variants */
.card-header.bg-warning { background: #f3caff !important; color: #6b37a6 !important; }
.card-header.bg-primary { background: #b67ee6 !important; color: #fff !important; }
.card-header.bg-danger { background: #d36bea !important; color: #fff !important; }
.card-header.bg-success { background: #8d53c9 !important; color: #fff !important; }
.card-header.bg-info { background: #d7c2f6 !important; color: #633ea5 !important; }
.card-header.bg-dark { background: #a459c8 !important; color: #fff !important; }
.card-header.bg-secondary { background: #d9b7fd !important; color: #7847a8 !important; }
.card-header { font-weight: bold; padding: 0.8em 1.3em; border-radius: 12px 12px 0 0;}

.flagged-trans-list {
  margin: 0;
  padding: 0;
  list-style: none;
}
.flagged-trans-list li {
  background: #f3caff;
  color: #993fc7;
  border-radius: 10px;
  font-weight: 500;
  font-size: 1.07rem;
  margin-bottom: 11px;
  padding: 12px 16px;
  display: flex; align-items: center;
}
.flagged-trans-list li .bi {
  margin-right: 8px;
}
.security-card {
  background: #f1e2ff;
  border-radius: 12px;
  padding: 22px 19px;
  box-shadow: 0 2px 11px #bb8afd16;
  max-width: 620px;
  margin: 0 auto 18px auto;
}
.security-card h4 {
  font-size: 1.07rem; color: #993fc7;
  margin-bottom: 7px;
  font-weight: bold;
}
.security-card ul {
  padding-left: 24px;
}
.security-card ul li {
  font-size: 1rem; margin-bottom: 4px;
  color: #a459c8;
  font-weight: 500;
  letter-spacing: .09px;
}

/* Styled buttons in purple spectrum */
.btn-primary,
.btn-outline-primary { background-color: #a459c8 !important; border-color: #d6b3ee !important; color: #fff; }
.btn-primary:hover,
.btn-outline-primary:hover { background-color: #c482e3 !important; border-color: #a459c8 !important; }
.btn-success, .btn-outline-success { background-color: #8d53c9 !important; border-color: #a459c8 !important; color: #fff; }
.btn-success:hover, .btn-outline-success:hover { background-color: #a459c8 !important; border-color: #8d53c9 !important; }
.btn-warning, .btn-outline-warning { background-color: #f3caff !important; color: #6b37a6 !important; border-color: #da95eb !important; }
.btn-info, .btn-outline-info { background-color: #d7c2f6 !important; color: #633ea5 !important; border-color: #b67ee6 !important; }
.btn-danger, .btn-outline-danger { background-color: #d36bea !important; color: #fff !important; border-color: #693185 !important; }
.btn { border-radius: 8px; }

/* Pastel color text highlights */
.text-success { color: #7a4fff !important;}
.text-danger { color: #d36bea !important;}
.text-primary { color: #b67ee6 !important;}

/* Loader */
.loader-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.8);
  display: flex; justify-content: center; align-items: center;
  z-index: 1050; flex-direction: column;
}

.card { border-radius: 15px; transition: transform 0.2s; }
.card:hover { transform: translateY(-2px); }
canvas { max-height: 250px; }

.suggestion-item {
  background: #eee5fa;
  border-left: 5px solid #a36bff;
  padding: 10px 14px;
  margin-bottom: 8px;
  border-radius: 8px;
  color: #4b2c6f;
  font-weight: 500;
}
.suggestion-item.alert {
  background: #fbefff;
  border-left-color: #d36cff;
  color: #a02bb6;
}
</style>

<!-- Sidebar Navigation -->
<nav class="sidebar-nav" aria-label="Side Navigation">
  <div class="sidebar-brand">Finance System</div>
  <div class="sidebar-menu">
    <a href="{% url 'dashboard' %}" class="active"><i class="bi bi-house-door-fill"></i><span>Dashboard</span></a>
    <a href="{% url 'transactions:list' %}"><i class="bi bi-cash-coin"></i><span>Transactions</span></a>
    <a href="{% url 'fraud_alerts' %}"><i class="bi bi-exclamation-triangle"></i><span>Fraud Alerts</span></a>
    <a href="{% url 'reports' %}"><i class="bi bi-bar-chart-line"></i><span>Reports</span></a>
    <a href="{% url 'settings' %}"><i class="bi bi-gear"></i><span>Settings</span></a>
  </div>
  <div class="sidebar-footer">¬© {{ now|date:"Y" }} FinSecure</div>
</nav>

<!-- Main dashboard -->
<div class="main-content">
  <!-- Loader -->
  <div id="loader" class="loader-overlay d-none">
    <div class="spinner-border text-primary" role="status"></div>
    <span class="ms-2">Loading...</span>
  </div>

  <!-- User Welcome Card -->
  <div class="dashboard-header-card">
    <div class="profile-card">
      <div class="profile-header">
        {% if user.profile.profile_photo %}
          <img src="{{ user.profile.profile_photo.url }}" alt="{{ user.username }} Profile">
        {% else %}
          <img src="{% static 'images/default-profile.png' %}" alt="Default Profile">
        {% endif %}
        <div>
          <h2>Welcome, {{ user.username }} üëã</h2>
          <p>Your personalized financial dashboard</p>
        </div>
      </div>

      <hr>
      <div class="profile-details">
        <p><strong>üìß Email:</strong> {{ user.email }}</p>
        <p><strong>üìû Phone:</strong> {{ user.profile.phone }}</p>
        <p><strong>üíº Occupation:</strong> {{ user.profile.occupation }}</p>
        <p><strong>üí∞ Income:</strong> ‚Çπ{{ user.profile.income|floatformat:2 }}</p>
      </div>

      <div style="margin-top: 15px;">
        <a href="{% url 'profile' %}" class="btn btn-primary">‚úè Update Profile</a>
        {% if gmail_connected %}
          <span class="badge bg-success">‚úî Gmail Connected</span>
        {% else %}
          <a href="{% url 'connect_gmail' %}" class="btn btn-outline-secondary">Connect Gmail</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Widgets -->
  <div class="dashboard-card">
    <div class="row gx-3">
      <!-- Assistance -->
      <div class="col-md-4 mb-3">
        <div class="card h-100 p-2 shadow-sm">
          <div class="card-header bg-warning text-dark fw-bold">Financial Assistance</div>
          <div class="card-body text-center">
            <a href="{% url 'assist_home_home' %}" class="btn btn-warning btn-lg">üíµ Financial Assistance</a>
          </div>
        </div>
      </div>
      <!-- Transactions -->
      <div class="col-md-4 mb-3">
        <div class="card h-100 p-2 shadow-sm">
          <div class="card-header bg-dark text-white">Transactions</div>
          <div class="card-body d-flex flex-column justify-content-center align-items-center">
            <a href="{% url 'transactions:add' %}" class="btn btn-success btn-sm mb-2">Add Transaction</a>
            <a href="{% url 'transactions:list' %}" class="btn btn-outline-primary btn-sm">View All</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Smart Suggestions -->
    <div class="card shadow-sm mt-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">üí° Smart Suggestions</h5>
      </div>
      <div class="card-body">
        {% if suggestions %}
          <ul class="list-group list-group-flush">
            {% for s in suggestions %}
              <li class="list-group-item d-flex align-items-center">
                {% if s.is_alert %}
                  <span class="me-2 text-danger fw-bold">‚ö†Ô∏è</span>
                {% else %}
                  <span class="me-2 text-success">üí°</span>
                {% endif %}
                <span>{{ s.suggestion }}</span>
                <small class="text-muted ms-auto">{{ s.created_at|date:"M d, Y H:i" }}</small>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">No suggestions available yet.</p>
        {% endif %}
      </div>
    </div>

<!-- Gmail Transactions -->
<div class="card shadow-sm mt-4">
  <div class="card-header bg-success text-white">
    <h5 class="mb-0">üí∞ Recent Gmail Transactions</h5>
  </div>
  <div class="card-body">
    {% if transactions %}
      <div class="table-responsive">
        <table class="table table-striped table-hover gmail-txns align-middle">
          <thead>
            <tr>
              <th>Description</th>
              <th>Amount</th>
              <th>Currency</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody>
            {% for txn in transactions %}
              <tr>
                <td>{{ txn.description }}</td>
                <td>{{ txn.amount }}</td>
                <td>{{ txn.currency }}</td>
                <td>
                  <a href="https://mail.google.com/mail/u/0/#inbox/{{ txn.message_id }}" 
                     target="_blank" 
                     class="btn btn-sm btn-outline-primary">
                     üìß View Email
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">No Gmail transactions found.</p>
    {% endif %}
  </div>
</div>


    <!-- Latest Emails -->
    <div class="row gx-3">
      <div class="col-md-12 mb-3">
        <div class="card h-100 p-2 shadow-sm">
          <div class="card-header bg-info text-white">üìß Latest Emails</div>
          <div class="card-body">
            {% if latest_emails %}
              <ul class="list-group list-group-flush">
                {% for email in latest_emails %}
                  <li class="list-group-item">
                    <strong>From:</strong> {{ email.from }}<br>
                    <strong>Subject:</strong> {{ email.subject }}<br>
                    <small>{{ email.snippet }}</small>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">
              {% if gmail_connected %}
                No recent emails found.
              {% else %}
                Please connect Gmail to see emails.
              {% endif %}
              </p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Financial Health -->
  <div class="dashboard-card">
    <div class="card-header bg-warning d-flex justify-content-between align-items-center">
      <span class="fw-bold">üìä Financial Health Summary</span>
      <div>
        <button id="filter7" class="btn btn-sm btn-outline-primary">Last 7 Days</button>
        <button id="filter30" class="btn btn-sm btn-outline-success">Last 30 Days</button>
        <button id="filterAll" class="btn btn-sm btn-outline-primary">All Time</button>
      </div>
    </div>
    <div class="row text-center mt-3 mb-2">
      <div class="col-md-3 border-end">
        <h6>Income</h6>
        <p class="text-success fw-bold">‚Çπ<span id="income-card">{{ income|default:"0.00"|floatformat:2 }}</span></p>
      </div>
      <div class="col-md-3 border-end">
        <h6>Spending</h6>
        <p class="text-danger fw-bold">‚Çπ<span id="spending">{{ spending|default:"0.00"|floatformat:2 }}</span></p>
      </div>
      <div class="col-md-3 border-end">
        <h6>Savings</h6>
        <p class="text-primary fw-bold">‚Çπ<span id="savings">{{ savings|default:"0.00"|floatformat:2 }}</span></p>
      </div>
      <div class="col-md-3">
        <h6>Alerts</h6>
        <ul id="alerts" class="list-unstyled text-danger small">
          {% for alert in alerts %}
            <li>üîî {{ alert }}</li>
          {% empty %}
            <li class="text-success">No unusual activity</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Spending Graphs -->
  <div class="dashboard-card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center toggle-collapse"
         data-bs-toggle="collapse" data-bs-target="#spendingGraphs" style="cursor:pointer;">
      <span>üìà Spending Graphs</span>
      <span class="arrow">‚ñº</span>
    </div>
    <div id="spendingGraphs" class="collapse">
      <div class="row mt-4 mb-2">
        <div class="col-md-4 mb-2"><h6>Spending (7 Days)</h6><canvas id="spendingChart7d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Spending (30 Days)</h6><canvas id="spendingChart30d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Spending (All Time)</h6><canvas id="spendingChartAll"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Fraud Amount Graphs -->
  <div class="dashboard-card">
    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center toggle-collapse"
         data-bs-toggle="collapse" data-bs-target="#fraudAmountGraphs" style="cursor:pointer;">
      <span>‚ö†Ô∏è Fraud Amount Graphs</span>
      <span class="arrow">‚ñº</span>
    </div>
    <div id="fraudAmountGraphs" class="collapse">
      <div class="row mt-4 mb-2">
        <div class="col-md-4 mb-2"><h6>Fraud Amount (7 Days)</h6><canvas id="fraudAmountChart7d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Fraud Amount (30 Days)</h6><canvas id="fraudAmountChart30d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Fraud Amount (All Time)</h6><canvas id="fraudAmountChartAll"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Fraud Count Graphs -->
  <div class="dashboard-card">
    <div class="card-header bg-warning d-flex justify-content-between align-items-center toggle-collapse"
         data-bs-toggle="collapse" data-bs-target="#fraudCountGraphs" style="cursor:pointer;">
      <span>üìä Fraud Count Graphs</span>
      <span class="arrow">‚ñº</span>
    </div>
    <div id="fraudCountGraphs" class="collapse">
      <div class="row mt-4 mb-2">
        <div class="col-md-4 mb-2"><h6>Fraud Count (7 Days)</h6><canvas id="fraudCountChart7d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Fraud Count (30 Days)</h6><canvas id="fraudCountChart30d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Fraud Count (All Time)</h6><canvas id="fraudCountChartAll"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chartInstances = {};
function renderChart(canvasId, labels, dataArr, labelName, color, type="line") {
  if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
  const ctx = document.getElementById(canvasId).getContext("2d");
  chartInstances[canvasId] = new Chart(ctx, {
    type: type,
    data: { labels: labels, datasets: [{ label: labelName, data: dataArr,
      borderColor: color, backgroundColor: type==="line"? color+"33": color,
      fill: type==="line", tension:0.3 }] },
    options: { responsive: true, plugins: { legend: { position: "top" } } }
  });
}
function fetchDashboardData(period="all") {
  document.getElementById("loader").classList.remove("d-none");
  fetch(`{% url 'dashboard_data' %}?period=${period}`)
    .then(r=>r.json()).then(data=>{
      document.getElementById('income-card').innerText = data.income.toFixed(2);
      document.getElementById('spending').innerText = data.spending.toFixed(2);
      document.getElementById('savings').innerText = data.savings.toFixed(2);
      // Alerts
      const alertsBox=document.getElementById("alerts"); alertsBox.innerHTML="";
      if(data.alerts.length){data.alerts.forEach(a=>alertsBox.innerHTML+=`<li>üîî ${a}</li>`);} else {alertsBox.innerHTML='<li class="text-success">No unusual activity</li>';}
      // Suggestions
      const sugBox=document.getElementById("suggestions"); sugBox.innerHTML="";
      if(data.suggestions.length){
        data.suggestions.forEach(s=>{
          if(s.includes("‚ö†Ô∏è")){sugBox.innerHTML+=`<li class="suggestion-item alert">${s}</li>`;}
          else{sugBox.innerHTML+=`<li class="suggestion-item">üí° ${s}</li>`;}
        });
      } else {
        sugBox.innerHTML='<li class="text-muted">No suggestions available.</li>';
      }
      renderChart("spendingChart7d",data.labels_7d,data.spending_7d,"Spending (7d)","#b67ee6");
      renderChart("spendingChart30d",data.labels_30d,data.spending_30d,"Spending (30d)","#993fc7");
      renderChart("spendingChartAll",data.labels_all,data.spending_all,"Spending (All)","#a459c8");
      renderChart("fraudAmountChart7d",data.labels_7d,data.fraud_7d_amount,"Fraud Amount (7d)","#d36bea","bar");
      renderChart("fraudAmountChart30d",data.labels_30d,data.fraud_30d_amount,"Fraud Amount (30d)","#8d53c9","bar");
      renderChart("fraudAmountChartAll",data.labels_all,data.fraud_all_amount,"Fraud Amount (All)","#b67ee6","bar");
      renderChart("fraudCountChart7d",data.labels_7d,data.fraud_7d_count,"Fraud Count (7d)","#c992e0","bar");
      renderChart("fraudCountChart30d",data.labels_30d,data.fraud_30d_count,"Fraud Count (30d)","#993fc7","bar");
      renderChart("fraudCountChartAll",data.labels_all,data.fraud_all_count,"Fraud Count (All)","#e9bafd","bar");
    }).finally(()=>document.getElementById("loader").classList.add("d-none"));
}
document.getElementById("filter7").addEventListener("click",()=>fetchDashboardData("7"));
document.getElementById("filter30").addEventListener("click",()=>fetchDashboardData("30"));
document.getElementById("filterAll").addEventListener("click",()=>fetchDashboardData("all"));
window.onload=()=>fetchDashboardData("all");
document.querySelectorAll(".toggle-collapse").forEach(h=>{
  const arrow=h.querySelector(".arrow"); const targetId=h.getAttribute("data-bs-target"); const t=document.querySelector(targetId);
  t.addEventListener("show.bs.collapse",()=>arrow.textContent="‚ñ≤");
  t.addEventListener("hide.bs.collapse",()=>arrow.textContent="‚ñº");
});

<!-- Display Django messages -->
{% if messages %}
<div class="messages-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="margin-bottom: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); {% if message.tags == 'warning' %}background-color: #fff3cd; border: 1px solid #ffc107; color: #856404;{% elif message.tags == 'error' %}background-color: #f8d7da; border: 1px solid #f44336; color: #721c24;{% elif message.tags == 'success' %}background-color: #d4edda; border: 1px solid #28a745; color: #155724;{% else %}background-color: #d1ecf1; border: 1px solid #17a2b8; color: #0c5460;{% endif %}">
        <strong>{{ message.tags|title }}:</strong> {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="float: right; background: none; border: none; font-size: 1.5rem; line-height: 1; color: inherit; opacity: 0.5; cursor: pointer;">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {% endfor %}
</div>

<script>
    // Auto-dismiss messages after 5 seconds
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 500);
        });
    }, 5000);
</script>
{% endif %}

</script>
{% endblock %}

