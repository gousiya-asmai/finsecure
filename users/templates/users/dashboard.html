{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
/* Navbar Override - Change to Blue */
nav.navbar,
.navbar,
header,
.top-navbar,
.main-navbar {
  background: linear-gradient(135deg, #1a5f8a 0%, #2178b5 100%) !important;
  background-color: #2178b5 !important;
}

body {
  background: linear-gradient(120deg, #e5f0fa 15%, #c8e2f7 92%);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
}
.sidebar-nav {
  position: fixed;
  top: 0; left: 0; bottom: 0;
  width: 250px; /* Full width always */
  background: #0f5279;
  box-shadow: 2px 0 16px #79b4e060;
  z-index: 1100;
  display: flex;
  flex-direction: column;
  transition: width .20s cubic-bezier(.4,2,.6,1);

}
.sidebar-nav.expanded { width: 250px; }
.menu-toggle-btn {
  background: none;
  border: none;
  color: #e1f4ff;
  font-size: 2rem;
  padding: 24px 0 19px 0;
  text-align: center;
  cursor: pointer;
  outline: none;
  margin-bottom: 4px;
  display: block;
}


.sidebar-brand {
  color: #e1f4ff;
  font-weight: bold;
  font-size: 1.3rem;
  text-align: center;
  letter-spacing: .6px;
  padding:  0 0 13px 0;
  white-space:nowrap;
  opacity: 0;
  height:0;
  transition: opacity .18s, height .18s;

}
.sidebar-nav.expanded .sidebar-brand { opacity:1; height:auto; padding-top:25px;}
.sidebar-menu {
  flex: 1; margin-top: 0;
  display: flex; flex-direction: column;
}
.sidebar-menu a,
.sidebar-menu .submenu-toggle {
  display: flex; align-items: center;
  font-size: 0;
  font-weight: 500;
  color: #e0f3ff;
  padding: 16px 20px 16px 20px;
  text-decoration: none;
  border-left: 5px solid transparent;
  transition: background .14s, color .14s, border-color .2s, font-size .18s, padding .18s;
  border-radius: 6px 0 0 6px;
  margin-bottom: 2px;
  cursor: pointer;
  background: none;
  border: none;
  outline: none;
}


.sidebar-menu a .bi,
.sidebar-menu .submenu-toggle .bi { margin-right: 0; font-size: 1.26em;}
.sidebar-menu a.active, .sidebar-menu a:hover,
.sidebar-menu .submenu-toggle.active, .sidebar-menu .submenu-toggle:hover {
  background: #2178b5;
  color: #fff;
  border-left: 5px solid #80c2fa;
}

.sidebar-menu a span,
.sidebar-menu .submenu-toggle span {
  margin-left: 8px;
  white-space:nowrap;
  transition: opacity .17s;
  opacity:0;
  pointer-events:none;
  font-size: 1.02em;
}



.sidebar-nav.expanded .sidebar-menu a,
.sidebar-nav.expanded .sidebar-menu .submenu-toggle{
  font-size: 1.07rem;
  padding: 14px 32px 14px 26px;
}
.sidebar-nav.expanded .sidebar-menu a span,
.sidebar-nav.expanded .sidebar-menu .submenu-toggle span {
  opacity:1; pointer-events:auto;
}

/* Submenu styles */
.sidebar-menu .submenu {
  max-height: 0;
  overflow: hidden;
  background: #165e88;
  transition: max-height 0.27s cubic-bezier(.4,2,.6,1);
  margin-left: 0;
  padding-left: 0;
}
.sidebar-menu .submenu.open {
  max-height: 180px;
}
.sidebar-menu .submenu a {
  font-size: 0;
  padding: 14px 32px 14px 56px;
  border-radius: 6px 0 0 6px;
  border-left: 3px solid #0f5279 !important;
  color: #cbe8fc;
  background: none;
  margin-bottom: 0;
}
.sidebar-nav.expanded .sidebar-menu .submenu a {
  font-size: 1rem;
}
.sidebar-menu .submenu a.active, .sidebar-menu .submenu a:hover {
  background: #2178b5;
  color: #fff;
  border-left: 3px solid #80c2fa !important;
}
.sidebar-menu .submenu-arrow {
  margin-left: auto;
  transition: transform 0.2s;
}
.sidebar-menu .submenu-toggle[aria-expanded="true"] .submenu-arrow {
  transform: rotate(90deg);
}


.sidebar-footer {
  text-align: center;
  padding: 12px 0 0 0;
  color: #9ccfe7;
  font-size: 0.99rem;
}

.main-content {
  margin-left: 250px;
  padding: 32px 36px 32px 36px;
  min-height: 100vh;
  transition: margin-left .20s cubic-bezier(.4,2,.6,1);

}
.sidebar-nav.expanded ~ .main-content {
  margin-left: 250px;
}



/* Top Card: Welcome/Profile */
.dashboard-header-card {
  max-width: 950px;
  margin: 0 auto 28px auto;
  background: linear-gradient(95deg, #f3f9fe 87%, #ddedfb 100%);
  border-radius: 20px;
  box-shadow: 0 4px 28px #77a8db17;
  padding: 28px 32px 18px 32px;
  display: flex; flex-direction:column;
}
.profile-card {
  display: flex; flex-direction: column; gap:8px;
}
.profile-header {
  display: flex;
  align-items: center;
  gap: 18px;
}
.profile-header img {
  border-radius: 50%;
  width: 68px;
  height: 68px;
  object-fit: cover;
  border: 3px solid #cbe9f7;
}
.profile-details { margin-top: 14px; }
.profile-details p { margin: 5px 0; color: #2372a7;}
.dashboard-header-card hr {margin:10px 0 6px 0;}
.dashboard-card {
  background: linear-gradient(135deg, #f9fcfe 98%, #dcedf7 100%);
  border-radius: 17px;
  box-shadow: 0 7px 19px #9dd1e814, 0 1px 10px #60aee410;
  padding: 20px 24px 18px 24px;
  margin-bottom: 22px;
}
.card-header.bg-primary {
  background: #2178b5 !important;
  color: #fff !important;
}
.card-header.bg-warning { background: #def1ff !important; color: #2178b5 !important; }
.card-header.bg-success { background: #94d7c4 !important; color: #24705b !important; }
.card-header.bg-info { background: #e4f2fa !important; color: #3082b7 !important; }
.card-header.bg-dark { background: #256a92 !important; color: #fff !important; }
.card-header { font-weight: bold; padding: 0.8em 1.3em; border-radius: 12px 12px 0 0;}
.btn-primary, .btn-outline-primary {
  background-color: #2178b5 !important;
  border-color: #bee5fd !important; color: #fff;
}
.btn-primary:hover, .btn-outline-primary:hover {
  background-color: #329ae6 !important; border-color: #2178b5 !important;
}
.btn-success, .btn-outline-success { background-color: #36a397 !important; border-color: #4bc8b7 !important; color: #fff;}
.btn-success:hover, .btn-outline-success:hover { background-color: #1d867e !important; border-color: #36a397 !important;}
.btn-warning, .btn-outline-warning { background-color: #f3f9fe !important; color: #2178b5 !important; border-color: #c2e5ff !important;}
.btn-info, .btn-outline-info { background-color: #e4f2fa !important; color: #2178b5 !important; border-color: #a9cadd !important;}
.btn-danger, .btn-outline-danger { background-color: #be6c91 !important; color: #fff !important; border-color: #9c3d65 !important;}
.btn { border-radius: 8px; }

.graph-section { display: none; }
.graph-section.active { display: block; }

.sidebar-menu .submenu-vertical {
  display: none;
  background: #165e88;
  margin-left: 0;
  border-radius: 6px 0 0 6px;
  padding: 0;
}
.sidebar-menu .submenu-vertical.open { display: block; }
.sidebar-menu .submenu-vertical a {
  display: flex;
  align-items: center;
  color: #e0f3ff;
  font-size: 1rem;
  padding: 14px 32px 14px 56px;
  border-radius: 6px 0 0 6px;
  border-left: 3px solid #0f5279 !important;
  background: none;
  margin-bottom: 0;
  text-decoration: none;
  transition: background .14s, color .14s, border-color .2s;
}
.sidebar-menu .submenu-vertical a.active, .sidebar-menu .submenu-vertical a:hover {
  background: #2178b5;
  color: #fff;
  border-left: 3px solid #80c2fa !important;
}
.sidebar-menu .submenu-vertical .bi {
  margin-right: 10px;
  font-size: 1.18em;
}

:root {
  --bg-main: #e5f0fa;
  --bg-card: #f9fcfe;
  --bg-sidebar: #0f5279;
  --text-color: #222;
  --card-shadow: 0 7px 19px #9dd1e814;
}

body.dark-mode {
  --bg-main: #0f202d;
  --bg-card: #1b2a3b;
  --bg-sidebar: #102f46;
  --text-color: #f0f4f8;
  --card-shadow: 0 7px 19px #00000040;
}

/* Apply variables */
body {
  background: var(--bg-main);
  color: var(--text-color);
}
.dashboard-card,
.dashboard-header-card {
  background: var(--bg-card);
  box-shadow: var(--card-shadow);
}
.sidebar-nav {
  background: var(--bg-sidebar);
}

</style>
<!-- Sidebar Navigation -->
<nav class="sidebar-nav" aria-label="Side Navigation" id="sidebar-nav">
  <button class="menu-toggle-btn" id="menu-toggle-btn" aria-label="Expand/collapse sidebar">
    <i class="bi bi-list"></i>
  </button>

  <div class="sidebar-brand">FinSecure</div>
  <div class="sidebar-menu">
    <a href="{% url 'dashboard' %}" class="active"><i class="bi bi-house-door-fill"></i><span>Dashboard</span></a>
    <div>
      <button class="submenu-toggle" id="transactions-menu" aria-expanded="false">
        <i class="bi bi-cash-coin"></i><span>Transactions</span>
        <span class="submenu-arrow bi bi-chevron-right"></span>
      </button>
      <div class="submenu" id="transactions-submenu">
        <a href="{% url 'transactions:add' %}"><i class="bi bi-plus-circle"></i><span>Add Transaction</span></a>
        <a href="{% url 'transactions:list' %}"><i class="bi bi-list-ul"></i><span>View All</span></a>
      </div>
    </div>

    <a href="{% url 'fraud_alerts' %}"><i class="bi bi-exclamation-triangle"></i><span>Fraud Alerts</span></a>
    <button class="submenu-toggle" id="reports-menu" aria-expanded="false">

        <i class="bi bi-bar-chart-line"></i><span>Reports</span>
        <span class="submenu-arrow bi bi-chevron-right"></span>
      </button>
      <div class="submenu-vertical" id="reports-submenu">
        <a href="#" class="show-graph" data-graph="spending"><i class="bi bi-graph-up"></i>Spending Graphs</a>
        <a href="#" class="show-graph" data-graph="fraud-amount"><i class="bi bi-exclamation-diamond"></i>Fraud Amount</a>
        <a href="#" class="show-graph" data-graph="fraud-count"><i class="bi bi-bar-chart"></i>Fraud Count</a>
      </div>
    <a href="{% url 'settings' %}"><i class="bi bi-gear"></i><span>Settings</span></a>
  </div>
  <div class="sidebar-footer">Â© {{ now|date:"Y" }} FinSecure</div>
</nav>

<!-- Main Content -->
<div class="main-content">
  <!-- Loader -->
  <div id="loader" class="loader-overlay d-none">
    <div class="spinner-border text-primary" role="status"></div>
    <span class="ms-2">Loading...</span>
  </div>

  <!-- User Profile Card (Enhanced) -->
  <div class="dashboard-header-card">
    <div class="profile-card">
      <div class="profile-header">
        {% if user.profile.profile_photo %}
          <img src="{{ user.profile.profile_photo.url }}" alt="{{ user.username }} Profile">
        {% else %}
          <img src="{% static 'images/default-profile.png' %}" alt="Default Profile">
        {% endif %}
        <div>
          <h2>Welcome, {{ user.get_full_name|default:user.username }} ð</h2>
          <p>Your personalized financial dashboard</p>
        </div>
      </div>
      <hr>
      <div class="profile-details">
        <p><strong>ð§ Email:</strong> {{ user.email }}</p>
        <p><strong>ð Phone:</strong> {{ user.profile.phone|default:"Not set" }}</p>
        <p><strong>ð¼ Occupation:</strong> {{ user.profile.occupation|default:"Not set" }}</p>
        <p><strong>ð° Income:</strong> â¹<span id="income">{{ income|default:user.profile.income|default:"0.00"|floatformat:2 }}</span></p>
      </div>
      <div style="margin-top: 15px;">
        <a href="{% url 'profile' %}" class="btn btn-primary btn-sm"><i class="bi bi-pencil"></i> Update Profile</a>
        {% if gmail_connected %}
          <span class="badge bg-success ms-2"><i class="bi bi-check-circle"></i> Gmail Connected</span>
        {% else %}
          <a href="{% url 'connect_gmail' %}" class="btn btn-danger btn-sm ms-2"><i class="bi bi-envelope"></i> Connect Gmail</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Featured Widgets -->
  <div class="dashboard-card">
    <div class="row gx-3">
      <div class="col-md-4 mb-3">
        <div class="card h-100 p-2 shadow-sm">
          <div class="card-header bg-warning text-dark fw-bold">Financial Assistance</div>
          <div class="card-body text-center">
            <a href="{% url 'assist_home_home' %}" class="btn btn-warning btn-lg">ðµ Financial Assistance</a>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card h-100 p-2 shadow-sm">
          <div class="card-header bg-dark text-white">Transactions</div>
          <div class="card-body d-flex flex-column justify-content-center align-items-center">
            <a href="{% url 'transactions:add' %}" class="btn btn-success btn-sm mb-2">Add Transaction</a>
            
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card h-100 p-2 shadow-sm">
          <div class="card-header bg-success text-white">Smart Suggestions</div>
          <div class="card-body">
            <ul id="suggestions" class="list-group list-group-flush">
              {% if suggestions %}
                {% for s in suggestions %}
                  <li class="list-group-item d-flex align-items-center {% if s.is_alert %}alert{% endif %}">
                    {% comment %}
                      s might be:
                        - a string (older code) -> display s
                        - an object/dict with keys suggestion/is_alert/created_at
                    {% endcomment %}
                    {% if s.suggestion %}
                      {% if s.is_alert %}
                        <span class="me-2 text-danger fw-bold">â </span>
                      {% else %}
                        <span class="me-2 text-success">ð¡</span>
                      {% endif %}
                      <span>{{ s.suggestion }}</span>
                      <small class="text-muted ms-auto">{{ s.created_at|date:"M d, Y H:i" }}</small>
                    {% else %}
                      <span class="me-2 text-success">ð¡</span>
                      <span>{{ s }}</span>
                    {% endif %}
                  </li>
                {% endfor %}
              {% else %}
                <li class="text-muted">No suggestions available.</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Gmail Transactions Table -->
    <div class="card shadow-sm mt-4">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">ð° Recent Gmail Transactions</h5>
      </div>
      <div class="card-body">
        {% if gmail_transactions %}
        <div class="table-responsive">
          <table class="table table-striped table-hover gmail-txns align-middle">
            <thead>
              <tr>
                <th>Description</th>
                <th>Amount</th>
                <th>Currency</th>
                <th>Email</th>
              </tr>
            </thead>
            <tbody>
              {% for txn in gmail_transactions %}
              <tr>
                <td>{{ txn.description }}</td>
                <td>{{ txn.amount }}</td>
                <td>{{ txn.currency|default:"INR" }}</td>
                <td>
                  {% if txn.message_id %}
                  <a href="https://mail.google.com/mail/u/0/#inbox/{{ txn.message_id }}" 
                     target="_blank" 
                     class="btn btn-sm btn-outline-primary">
                     ð§ View Email
                  </a>
                  {% else %}
                    <span class="text-muted">No message link</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted">No Gmail transactions found.</p>
        {% endif %}
      </div>
    </div>

    <!-- Latest Emails -->
    <div class="row gx-3 mt-4">
      <div class="col-md-12 mb-3">
        <div class="card h-100 p-2 shadow-sm">
          <div class="card-header bg-info text-white">ð§ Latest Emails</div>
          <div class="card-body">
            {% if latest_emails %}
              <ul class="list-group list-group-flush">
                {% for email in latest_emails %}
                  <li class="list-group-item">
                    <strong>From:</strong> {{ email.from }}<br>
                    <strong>Subject:</strong> {{ email.subject }}<br>
                    <small>{{ email.snippet }}</small>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">
                {% if gmail_connected %}
                  No recent emails found.
                {% else %}
                  Please connect Gmail to see emails.
                {% endif %}
              </p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Financial Health Summary -->
  <div class="dashboard-card">
    <div class="card-header bg-warning d-flex justify-content-between align-items-center">
      <span class="fw-bold">ð Financial Health Summary</span>
      <div>
        <button id="filter7" class="btn btn-sm btn-outline-primary">Last 7 Days</button>
        <button id="filter30" class="btn btn-sm btn-outline-success">Last 30 Days</button>
        <button id="filterAll" class="btn btn-sm btn-outline-primary">All Time</button>
      </div>
    </div>
    <div class="row text-center mt-3 mb-2">
      <div class="col-md-3 border-end">
        <h6>Income</h6>
        <p class="text-success fw-bold">â¹<span id="income-card">{{ income|default:"0.00"|floatformat:2 }}</span></p>
      </div>
      <div class="col-md-3 border-end">
        <h6>Spending</h6>
        <p class="text-danger fw-bold">â¹<span id="spending">{{ spending|default:"0.00"|floatformat:2 }}</span></p>
      </div>
      <div class="col-md-3 border-end">
        <h6>Savings</h6>
        <p class="text-primary fw-bold">â¹<span id="savings">{{ savings|default:"0.00"|floatformat:2 }}</span></p>
      </div>
      <div class="col-md-3">
        <h6>Alerts</h6>
        <ul id="alerts" class="list-unstyled text-danger small">
          {% for alert in alerts %}
            <li>ð {{ alert }}</li>
          {% empty %}
            <li class="text-success">No unusual activity</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Spending Graphs -->
  <div id="spending-graph-section" class="graph-section"></div>
  <div class="dashboard-card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center toggle-collapse"
         data-bs-toggle="collapse" data-bs-target="#spendingGraphs" style="cursor:pointer;">
      <span>ð Spending Graphs</span>
      <span class="arrow">â¼</span>
    </div>
    <div id="spendingGraphs" class="collapse">
      <div class="row mt-4 mb-2">
        <div class="col-md-4 mb-2"><h6>Spending (7 Days)</h6><canvas id="spendingChart7d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Spending (30 Days)</h6><canvas id="spendingChart30d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Spending (All Time)</h6><canvas id="spendingChartAll"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Fraud Amount Graphs -->
  <div id="fraud-amount-graph-section" class="graph-section"></div>
  <div class="dashboard-card">
    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center toggle-collapse"
         data-bs-toggle="collapse" data-bs-target="#fraudAmountGraphs" style="cursor:pointer;">
      <span>â  Fraud Amount Graphs</span>
      <span class="arrow">â¼</span>
    </div>
    <div id="fraudAmountGraphs" class="collapse show">

      <div class="row mt-4 mb-2">
        <div class="col-md-4 mb-2"><h6>Fraud Amount (7 Days)</h6><canvas id="fraudAmountChart7d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Fraud Amount (30 Days)</h6><canvas id="fraudAmountChart30d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Fraud Amount (All Time)</h6><canvas id="fraudAmountChartAll"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Fraud Count Graphs -->
  <div id="fraud-count-graph-section" class="graph-section"></div>
  <div class="dashboard-card">
    <div class="card-header bg-warning d-flex justify-content-between align-items-center toggle-collapse"
         data-bs-toggle="collapse" data-bs-target="#fraudCountGraphs" style="cursor:pointer;">
      <span>ð Fraud Count Graphs</span>
      <span class="arrow">â¼</span>
    </div>
    <div id="fraudCountGraphs" class="collapse">
      <div class="row mt-4 mb-2">
        <div class="col-md-4 mb-2"><h6>Fraud Count (7 Days)</h6><canvas id="fraudCountChart7d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Fraud Count (30 Days)</h6><canvas id="fraudCountChart30d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Fraud Count (All Time)</h6><canvas id="fraudCountChartAll"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  <!-- ==================== THEME TOGGLE + DASHBOARD SCRIPT ==================== -->
<script>
// ð Light/Dark mode toggle logic
const themeBtn = document.getElementById('theme-toggle');

if (themeBtn) {
  const applyTheme = (dark) => {
    document.body.classList.toggle('dark-mode', dark);
    themeBtn.innerHTML = dark 
      ? '<i class="bi bi-sun"></i> Light Mode' 
      : '<i class="bi bi-moon"></i> Dark Mode';

    // â Update Chart.js text/axes color dynamically
    Chart.defaults.color = dark ? '#fff' : '#000';
  };

  // Load previously saved theme
  const saved = localStorage.getItem('darkMode') === 'true';
  applyTheme(saved);

  // Toggle on click
  themeBtn.addEventListener('click', () => {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDark);
    applyTheme(isDark);

    // â Re-render charts when theme changes
    if (typeof loadDashboardData === "function") loadDashboardData();
  });
}


// ==================== DASHBOARD CHARTS & DATA ==================== //
async function loadDashboardData() {
  try {
    const response = await fetch("/users/dashboard-data/");
    const data = await response.json();

    // â Ensure Chart.js uses current theme color
    Chart.defaults.color = document.body.classList.contains('dark-mode') ? '#fff' : '#000';

    // ---- Spending Chart ----
    const ctx1 = document.getElementById("spendingChart").getContext("2d");
    if (window.spendingChart) window.spendingChart.destroy();
    window.spendingChart = new Chart(ctx1, {
      type: "bar",
      data: {
        labels: data.category_spending.map(x => x.category),
        datasets: [{
          label: "ð¸ Spending by Category",
          data: data.category_spending.map(x => x.total),
          backgroundColor: "rgba(255, 99, 132, 0.6)",
          borderRadius: 8,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: Chart.defaults.color } } },
        scales: {
          x: { ticks: { color: Chart.defaults.color } },
          y: { ticks: { color: Chart.defaults.color } }
        }
      }
    });

    // ---- Fraud Chart ----
    const ctx2 = document.getElementById("fraudChart").getContext("2d");
    if (window.fraudChart) window.fraudChart.destroy();
    window.fraudChart = new Chart(ctx2, {
      type: "doughnut",
      data: {
        labels: data.fraud_stats.map(x => x.is_fraud ? "Fraud" : "Legit"),
        datasets: [{
          label: "â ï¸ Fraud Detection",
          data: data.fraud_stats.map(x => x.count),
          backgroundColor: ["rgba(255, 99, 132, 0.8)", "rgba(75, 192, 192, 0.8)"],
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: Chart.defaults.color } } }
      }
    });

    // ---- Savings Chart ----
    const ctx3 = document.getElementById("savingsChart").getContext("2d");
    if (window.savingsChart) window.savingsChart.destroy();
    window.savingsChart = new Chart(ctx3, {
      type: "line",
      data: {
        labels: ["Income", "Spending", "Savings"],
        datasets: [{
          label: "ð° Financial Summary",
          data: [data.income, data.spending, data.savings],
          borderColor: "rgba(54, 162, 235, 0.8)",
          backgroundColor: "rgba(54, 162, 235, 0.2)",
          tension: 0.3,
          fill: true,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: Chart.defaults.color } } },
        scales: {
          x: { ticks: { color: Chart.defaults.color } },
          y: { ticks: { color: Chart.defaults.color } }
        }
      }
    });

  } catch (error) {
    console.error("â Error loading dashboard data:", error);
  }
}

// Load data when the page is ready
window.addEventListener("load", loadDashboardData);
</script>
<!-- ==================== END DASHBOARD SCRIPT ==================== -->

  // Sidebar toggle (safe guards)
  const sidebar = document.getElementById('sidebar-nav');
  const toggleBtn = document.getElementById('menu-toggle-btn');
  if (toggleBtn && sidebar) {
    toggleBtn.onclick = function() {
      sidebar.classList.toggle('expanded');
      const main = document.querySelector('.main-content');
      if (main) {
        if (sidebar.classList.contains('expanded')) {
          main.style.marginLeft = "250px";
        } else {
          main.style.marginLeft = "60px";
        }
      }
    };
  }

  // Transactions submenu toggle
  const submenuToggle = document.getElementById('transactions-menu');
  const submenu = document.getElementById('transactions-submenu');
  if (submenuToggle && submenu) {
    submenuToggle.onclick = function() {
      const expanded = submenuToggle.getAttribute('aria-expanded') === 'true';
      submenuToggle.setAttribute('aria-expanded', (!expanded).toString());
      submenu.classList.toggle('open');
    };
  }

  // Reports submenu vertical toggle
  const reportsToggle = document.getElementById('reports-menu');
  const reportsMenu = document.getElementById('reports-submenu');
  if (reportsToggle && reportsMenu) {
    reportsToggle.onclick = function() {
      const expanded = reportsToggle.getAttribute('aria-expanded') === 'true';
      reportsToggle.setAttribute('aria-expanded', (!expanded).toString());
      reportsMenu.classList.toggle('open');
    };
  }

  // Show graph section links
  document.querySelectorAll('.show-graph').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('.graph-section').forEach(sec => sec.classList.remove('active'));
      // mapping: data-graph values are 'spending', 'fraud-amount', 'fraud-count'
      if (this.dataset.graph === 'spending') {
        const el = document.getElementById('spending-graph-section');
        if (el) el.classList.add('active');
      }
      if (this.dataset.graph === 'fraud-amount') {
        const el = document.getElementById('fraud-amount-graph-section');
        if (el) el.classList.add('active');
      }
      if (this.dataset.graph === 'fraud-count') {
        const el = document.getElementById('fraud-count-graph-section');
        if (el) el.classList.add('active');
      }
      if (reportsMenu) {
        reportsMenu.classList.remove('open');
        reportsToggle.setAttribute('aria-expanded', 'false');
      }
      setTimeout(() => {
        let visible = document.querySelector('.graph-section.active');
        if (visible) visible.scrollIntoView({behavior: "smooth"});
      }, 100);
    });
  });

  // Charts storage so we can destroy and re-create
  let chartInstances = {};

  function renderChart(canvasId, labels, dataArr, labelName, color, type="line") {
    try {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
      const ctx = canvas.getContext("2d");
      chartInstances[canvasId] = new Chart(ctx, {
        type: type,
        data: {
          labels: labels,
          datasets: [{
            label: labelName,
            data: dataArr,
            borderColor: color || undefined,
            backgroundColor: type === "line" ? undefined : (color || undefined),
            fill: type === "line",
            tension: 0.3
          }]
        },
        options: { responsive: true, plugins: { legend: { position: "top" } } }
      });
    } catch (err) {
      console.error("renderChart error:", err, canvasId, labels, dataArr);
    }
  }

  // Helper: safe parse numbers (handles strings from JSON)
  function toNumberArr(arr) {
    return arr.map(x => {
      if (x === null || x === undefined) return 0;
      if (typeof x === 'number') return x;
      const n = parseFloat(x);
      return isNaN(n) ? 0 : n;
    });
  }

  // Core fetch function - uses the users view name 'get_dashboard_data'
  function fetchDashboardData(period = "all") {
    document.getElementById("loader")?.classList.remove("d-none");
    // Correct URL name: use get_dashboard_data (your users/urls.py registers this)
    fetch("{% url 'get_dashboard_data' %}?period=" + encodeURIComponent(period))
      .then(response => {
        if (!response.ok) throw new Error("Network response was not ok: " + response.status);
        return response.json();
      })
      .then(data => {
        // Some backends return floats, some strings; coerce numbers safely
        const income = (data.income !== undefined) ? Number(data.income) : 0;
        const spending = (data.spending !== undefined) ? Number(data.spending) : 0;
        const savings = (data.savings !== undefined) ? Number(data.savings) : (income - spending);

        // Update summary cards (check multiple possible element IDs)
        const incomeEls = [document.getElementById('income-card'), document.getElementById('income')].filter(Boolean);
        incomeEls.forEach(el => el.innerText = income.toFixed(2));

        const spendingEls = [document.getElementById('spending'), document.getElementById('spending-card')].filter(Boolean);
        spendingEls.forEach(el => el.innerText = spending.toFixed(2));

        const savingsEls = [document.getElementById('savings')].filter(Boolean);
        savingsEls.forEach(el => el.innerText = savings.toFixed(2));

        // Alerts
        const alertsBox = document.getElementById("alerts");
        if (alertsBox) {
          alertsBox.innerHTML = "";
          if (Array.isArray(data.alerts) && data.alerts.length) {
            data.alerts.forEach(a => {
              alertsBox.innerHTML += `<li>ð ${a}</li>`;
            });
          } else {
            alertsBox.innerHTML = `<li class="text-success">No unusual activity</li>`;
          }
        }

        // Suggestions (if backend includes suggestions)
        const suggestionsBox = document.getElementById("suggestions");
        if (suggestionsBox) {
          suggestionsBox.innerHTML = "";
          if (Array.isArray(data.suggestions) && data.suggestions.length) {
            data.suggestions.forEach(s => {
              suggestionsBox.innerHTML += `<li class="list-group-item">ð¡ ${ (s.suggestion) ? s.suggestion : s }</li>`;
            });
          } else {
            // If template passed suggestions already from server-side context, don't override with empty
            if (suggestionsBox.children.length === 0) {
              suggestionsBox.innerHTML = '<li class="list-group-item">No suggestions available.</li>';
            }
          }
        }

        // Prepare data for charts.
        // Priority: if backend returns labels_* and spending_* arrays, use them (time series).
        // Fallback: use category_spending (category totals) and fraud_stats for doughnut/bar charts.

        // Spending charts
        if (data.labels_7d && data.spending_7d) {
          renderChart("spendingChart7d", data.labels_7d, toNumberArr(data.spending_7d), "Spending (7d)", "#7193e6", "line");
        } else if (data.category_spending) {
          // If no time-series, populate category totals into the 7d chart as fallback
          const cats = data.category_spending.map(x => x.category || "Uncategorized");
          const totals = toNumberArr(data.category_spending.map(x => x.total));
          renderChart("spendingChart7d", cats, totals, "Spending by Category", "#7193e6", "bar");
        } else {
          // Clear chart if empty
          renderChart("spendingChart7d", [], [], "Spending (7d)", "#7193e6", "bar");
        }

        if (data.labels_30d && data.spending_30d) {
          renderChart("spendingChart30d", data.labels_30d, toNumberArr(data.spending_30d), "Spending (30d)", "#8f6ee0", "line");
        } else {
          renderChart("spendingChart30d", [], [], "Spending (30d)", "#8f6ee0", "bar");
        }

        if (data.labels_all && data.spending_all) {
          renderChart("spendingChartAll", data.labels_all, toNumberArr(data.spending_all), "Spending (All)", "#a459c8", "line");
        } else {
          // fallback to category totals
          if (data.category_spending) {
            const cats = data.category_spending.map(x => x.category || "Uncategorized");
            const totals = toNumberArr(data.category_spending.map(x => x.total));
            renderChart("spendingChartAll", cats, totals, "Spending (All)", "#a459c8", "bar");
          } else {
            renderChart("spendingChartAll", [], [], "Spending (All)", "#a459c8", "bar");
          }
        }

        // Fraud amount charts (if backend provides fraud series)
        if (data.fraud_7d_amount) {
          renderChart("fraudAmountChart7d", data.labels_7d || [], toNumberArr(data.fraud_7d_amount), "Fraud Amount (7d)", "#d36bea", "bar");
        } else {
          renderChart("fraudAmountChart7d", [], [], "Fraud Amount (7d)", "#d36bea", "bar");
        }
        if (data.fraud_30d_amount) {
          renderChart("fraudAmountChart30d", data.labels_30d || [], toNumberArr(data.fraud_30d_amount), "Fraud Amount (30d)", "#8d53c9", "bar");
        } else {
          renderChart("fraudAmountChart30d", [], [], "Fraud Amount (30d)", "#8d53c9", "bar");
        }
        if (data.fraud_all_amount) {
          renderChart("fraudAmountChartAll", data.labels_all || [], toNumberArr(data.fraud_all_amount), "Fraud Amount (All)", "#b67ee6", "bar");
        } else {
          renderChart("fraudAmountChartAll", [], [], "Fraud Amount (All)", "#b67ee6", "bar");
        }

        // Fraud count: backend likely returns fraud_stats (array of {is_fraud: ... , count: ...})
        if (Array.isArray(data.fraud_stats) && data.fraud_stats.length) {
          // order: fraud true first, then false
          const fraudRow = data.fraud_stats.find(r => String(r.is_fraud) === "True" || r.is_fraud === true) || {count:0};
          const nonFraudRow = data.fraud_stats.find(r => String(r.is_fraud) === "False" || r.is_fraud === false) || {count:0};
          const labels = ["Fraud", "Non-Fraud"];
          const counts = [Number(fraudRow.count || 0), Number(nonFraudRow.count || 0)];
          renderChart("fraudCountChart7d", labels, counts, "Fraud Count (count)", "#c992e0", "bar");
          renderChart("fraudCountChart30d", labels, counts, "Fraud Count (count)", "#993fc7", "bar");
          renderChart("fraudCountChartAll", labels, counts, "Fraud Count (count)", "#e9bafd", "bar");
          // also draw a compact fraud doughnut for the 'fraudAmountChart' area if desired
          renderChart("fraudAmountChart", labels, counts, "Fraud vs Non-Fraud", "#d36bea", "doughnut");
        } else {
          // If backend provided counts differently, try 'fraud_counts' keys (fallback)
          renderChart("fraudCountChart7d", [], [], "Fraud Count (7d)", "#c992e0", "bar");
          renderChart("fraudCountChart30d", [], [], "Fraud Count (30d)", "#993fc7", "bar");
          renderChart("fraudCountChartAll", [], [], "Fraud Count (All)", "#e9bafd", "bar");
        }
      })
      .catch(err => {
        console.error("Error loading dashboard data:", err);
        const alertsBox = document.getElementById("alerts");
        if (alertsBox) alertsBox.innerHTML = `<li class="text-danger">Error loading dashboard data</li>`;
      })
      .finally(() => {
        document.getElementById("loader")?.classList.add("d-none");
      });
  }

  // Wire up filter buttons safely
  const btn7 = document.getElementById("filter7");
  const btn30 = document.getElementById("filter30");
  const btnAll = document.getElementById("filterAll");
  if (btn7) btn7.addEventListener("click", () => fetchDashboardData("7"));
  if (btn30) btn30.addEventListener("click", () => fetchDashboardData("30"));
  if (btnAll) btnAll.addEventListener("click", () => fetchDashboardData("all"));

  // Toggle collapse arrows (Bootstrap collapse events assumed present)
  document.querySelectorAll(".toggle-collapse").forEach(header => {
    const arrow = header.querySelector(".arrow");
    const targetId = header.getAttribute("data-bs-target");
    const target = document.querySelector(targetId);
    if (!target) return;
    // if bootstrap loaded, these events will be available; if not, ignore
    try {
      target.addEventListener("show.bs.collapse", () => arrow.textContent = "â²");
      target.addEventListener("hide.bs.collapse", () => arrow.textContent = "â¼");
    } catch (e) { /* ignore if bootstrap not loaded */ }
  });

  // initial load
  window.addEventListener("load", () => fetchDashboardData("all"));
</script>
{% endblock %}
