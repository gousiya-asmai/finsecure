{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<!--
  Corrected dashboard.html
  - Fix: fraud doughnut canvas added (id="fraudDoughnut") and JS renders it.
  - Adds Light / Dark mode toggle and CSS variables.
  - Spending charts show line + bar datasets.
  - Safe guards for missing data and broken network responses.
-->

<style>
:root{
  --bg: #e5f0fa;
  --panel: #f9fcfe;
  --accent: #2178b5;
  --muted: #2372a7;
  --card-shadow: rgba(96,174,228,0.06);
  --text: #08384f;
  --positive: #2b8a4a;
  --negative: #b33a3a;
}
[data-theme="dark"]{
  --bg: #071226;
  --panel: #071a2b;
  --accent: #3aa0ff;
  --muted: #8fcaf2;
  --card-shadow: rgba(0,0,0,0.6);
  --text: #d7eefc;
  --positive: #7dd291;
  --negative: #f28b82;
}

/* Basic layout */
body { 
  background: linear-gradient(120deg,var(--bg) 15%, #c8e2f7 92%);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: var(--text);
  margin:0;
}

/* Sidebar */
.sidebar-nav{
  position: fixed; top:0; left:0; bottom:0;
  width: 250px;
  background: linear-gradient(180deg,#0d4f73 0%, #0f5279 100%);
  color: #eaf7ff;
  z-index:1100;
  display:flex; flex-direction:column;
  transition: width .18s;
  box-shadow: 2px 0 16px var(--card-shadow);
}
.sidebar-nav.collapsed { width: 60px; }
.menu-toggle-btn{
  background:none; border:none; color:inherit;
  font-size:1.5rem; padding:18px; cursor:pointer;
}
.sidebar-brand{ font-weight:700; text-align:center; padding:12px 8px; }
.sidebar-menu { display:flex; flex-direction:column; gap:6px; padding: 6px; }
.sidebar-menu a, .submenu-toggle{
  display:flex; align-items:center; gap:10px;
  padding:12px 14px; color:inherit; text-decoration:none;
  border-radius:8px; transition: background .12s;
}
.sidebar-menu a:hover, .submenu-toggle:hover { background: rgba(255,255,255,0.04); }
.sidebar-footer{ margin-top:auto; padding:12px; font-size:.9rem; color:#cfeefc; text-align:center; }

/* Main area */
.main-content{
  margin-left:250px; padding:28px; transition:margin-left .18s;
}
.sidebar-nav.collapsed ~ .main-content { margin-left:60px; }

/* Cards */
.dashboard-card, .card {
  background: var(--panel);
  border-radius: 14px;
  box-shadow: 0 6px 18px var(--card-shadow);
  padding:18px;
  margin-bottom:20px;
}
.dashboard-header-card{ padding:20px; border-radius:18px; max-width:1000px; margin:0 auto 20px; }
.profile-header{ display:flex; gap:16px; align-items:center; }
.profile-header img{ border-radius:50%; width:64px; height:64px; object-fit:cover; border:3px solid rgba(203,233,247,0.7); }

/* Buttons */
.btn { border-radius:8px; }
.btn-primary{ background:var(--accent); border: none; color: white; }
.btn-outline-primary{ background: transparent; border:1px solid rgba(0,0,0,0.06); color:var(--accent); }

/* Responsive */
@media (max-width: 900px){
  .sidebar-nav { transform: translateX(-100%); position: fixed; }
  .sidebar-nav.open { transform: translateX(0); }
  .main-content{ margin-left: 0; padding:18px; }
}

/* Graph placeholders */
canvas { width:100% !important; height:260px !important; }

/* small util */
.text-muted { color: #7b9bb3; }
.badge { padding:6px 8px; border-radius:8px; }

.dark-toggle {
  position: fixed; right: 18px; top: 18px;
  z-index: 2000;
  display:flex; gap:8px; align-items:center;
}
</style>

<!-- Light/Dark Toggle -->
<div class="dark-toggle">
  <button id="themeToggleBtn" class="btn btn-outline-primary btn-sm" title="Toggle light/dark">
    üåô / ‚òÄÔ∏è
  </button>
</div>

<!-- Sidebar -->
<nav id="sidebar-nav" class="sidebar-nav" aria-label="Side Navigation">
  <button id="menu-toggle-btn" class="menu-toggle-btn" aria-label="Toggle menu">
    <i class="bi bi-list" style="font-size:1.2rem"></i>
  </button>
  <div class="sidebar-brand">FinSecure</div>
  <div class="sidebar-menu">
    <a href="{% url 'dashboard' %}" class="active"><i class="bi bi-house-door-fill"></i> <span class="label">Dashboard</span></a>
    <div>
      <button id="transactions-menu" class="submenu-toggle" aria-expanded="false"><i class="bi bi-cash-coin"></i> <span class="label">Transactions</span></button>
      <div id="transactions-submenu" class="submenu" style="display:none; margin-left:8px;">
        <a href="{% url 'transactions:add' %}"><i class="bi bi-plus-circle"></i> <span class="label">Add</span></a>
        <a href="{% url 'transactions:list' %}"><i class="bi bi-list-ul"></i> <span class="label">List</span></a>
      </div>
    </div>
    <a href="{% url 'fraud_alerts' %}"><i class="bi bi-exclamation-triangle"></i> <span class="label">Fraud Alerts</span></a>

    <button id="reports-menu" class="submenu-toggle" aria-expanded="false"><i class="bi bi-bar-chart-line"></i> <span class="label">Reports</span></button>
    <div id="reports-submenu" class="submenu-vertical" style="display:none; margin-left:8px;">
      <a href="#" class="show-graph" data-graph="spending"><i class="bi bi-graph-up"></i> Spending</a>
      <a href="#" class="show-graph" data-graph="fraud-amount"><i class="bi bi-exclamation-diamond"></i> Fraud Amount</a>
      <a href="#" class="show-graph" data-graph="fraud-count"><i class="bi bi-bar-chart"></i> Fraud Count</a>
    </div>

    <a href="{% url 'settings' %}"><i class="bi bi-gear"></i> <span class="label">Settings</span></a>
  </div>
  <div class="sidebar-footer">¬© {{ now|date:"Y" }} FinSecure</div>
</nav>

<!-- Main Content -->
<div class="main-content" id="main-content">
  <!-- Loader (hidden by default) -->
  <div id="loader" class="d-none" style="position:fixed;left:50%;top:45%;transform:translate(-50%,-50%); z-index:1500; display:flex; align-items:center; gap:10px;">
    <div class="spinner-border text-primary" role="status"></div>
    <div>Loading...</div>
  </div>

  <!-- Header card -->
  <div class="dashboard-header-card">
    <div class="profile-card">
      <div class="profile-header">
        {% if user.profile.profile_photo %}
          <img src="{{ user.profile.profile_photo.url }}" alt="{{ user.username }} Profile">
        {% else %}
          <img src="{% static 'images/default-profile.png' %}" alt="Default Profile">
        {% endif %}
        <div>
          <h2 style="margin:0;">Welcome, {{ user.get_full_name|default:user.username }} üëã</h2>
          <div class="text-muted">Your personalized financial dashboard</div>
        </div>
      </div>
      <hr style="margin:12px 0;">
      <div class="profile-details" style="display:flex; gap:16px; flex-wrap:wrap;">
        <div><strong>üìß</strong> {{ user.email }}</div>
        <div><strong>üìû</strong> {{ user.profile.phone|default:"Not set" }}</div>
        <div><strong>üíº</strong> {{ user.profile.occupation|default:"Not set" }}</div>
        <div><strong>üí∞ Income</strong> ‚Çπ<span id="income">{{ income|default:user.profile.income|default:"0.00"|floatformat:2 }}</span></div>
        <div>
          <a href="{% url 'profile' %}" class="btn btn-primary btn-sm"><i class="bi bi-pencil"></i> Update Profile</a>
          {% if gmail_connected %}
            <span class="badge bg-success ms-2">Gmail Connected</span>
          {% else %}
            <a href="{% url 'connect_gmail' %}" class="btn btn-outline-primary btn-sm ms-2"><i class="bi bi-envelope"></i> Connect Gmail</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Top widgets -->
  <div class="dashboard-card">
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <div style="flex:1; min-width:240px;">
        <div class="card-header" style="background:transparent; padding:0 0 8px 0;"><strong>Financial Assistance</strong></div>
        <div style="display:flex; align-items:center; gap:10px;">
          <a href="{% url 'assist_home_home' %}" class="btn btn-warning">üíµ Get Assistance</a>
        </div>
      </div>

      <div style="flex:1; min-width:240px;">
        <div class="card-header" style="background:transparent; padding:0 0 8px 0;"><strong>Transactions</strong></div>
        <div><a href="{% url 'transactions:add' %}" class="btn btn-success">+ Add Transaction</a></div>
      </div>

      <div style="flex:1; min-width:240px;">
        <div class="card-header" style="background:transparent; padding:0 0 8px 0;"><strong>Smart Suggestions</strong></div>
        <ul id="suggestions" class="list-group list-group-flush" style="margin:0; padding-left:0;">
          {% if suggestions %}
            {% for s in suggestions %}
              <li class="list-group-item" style="border:none;padding:6px 0;">üí° {{ s }}</li>
            {% endfor %}
          {% else %}
            <li class="text-muted">No suggestions available.</li>
          {% endif %}
        </ul>
      </div>
    </div>

    <!-- Gmail transactions table -->
    <div style="margin-top:16px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h5 style="margin:0;">üí∞ Recent Gmail Transactions</h5>
      </div>
      <div style="margin-top:8px;">
        {% if gmail_transactions %}
          <div style="overflow:auto;">
            <table class="table table-striped">
              <thead>
                <tr><th>Description</th><th>Amount</th><th>Currency</th><th>Email</th></tr>
              </thead>
              <tbody>
                {% for txn in gmail_transactions %}
                <tr>
                  <td>{{ txn.description }}</td>
                  <td>{{ txn.amount }}</td>
                  <td>{{ txn.currency|default:"INR" }}</td>
                  <td>
                    {% if txn.message_id %}
                      <a target="_blank" class="btn btn-sm btn-outline-primary" href="https://mail.google.com/mail/u/0/#inbox/{{ txn.message_id }}">View Email</a>
                    {% else %}
                      <span class="text-muted">No link</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted">No Gmail transactions found.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Financial health -->
  <div class="dashboard-card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <strong>üìä Financial Health Summary</strong>
      <div>
        <button id="filter7" class="btn btn-sm btn-outline-primary">Last 7 Days</button>
        <button id="filter30" class="btn btn-sm btn-outline-primary">Last 30 Days</button>
        <button id="filterAll" class="btn btn-sm btn-outline-primary">All Time</button>
      </div>
    </div>

    <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
      <div style="flex:1; min-width:160px;">
        <div>Income</div>
        <div style="font-weight:700; color:var(--positive)">‚Çπ<span id="income-card">{{ income|default:"0.00"|floatformat:2 }}</span></div>
      </div>
      <div style="flex:1; min-width:160px;">
        <div>Spending</div>
        <div style="font-weight:700; color:var(--negative)">‚Çπ<span id="spending">{{ spending|default:"0.00"|floatformat:2 }}</span></div>
      </div>
      <div style="flex:1; min-width:160px;">
        <div>Savings</div>
        <div style="font-weight:700">‚Çπ<span id="savings">{{ savings|default:"0.00"|floatformat:2 }}</span></div>
      </div>
      <div style="flex:1; min-width:200px;">
        <div>Alerts</div>
        <ul id="alerts" class="list-unstyled" style="margin:0; padding-left:0;">
          {% if alerts %}
            {% for alert in alerts %}
              <li>üîî {{ alert }}</li>
            {% endfor %}
          {% else %}
            <li class="text-success">No unusual activity</li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Graphs -->
  <div class="dashboard-card" id="graphs-area">
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <div style="flex:1; min-width:320px;">
        <h6>üìà Spending (7d)</h6>
        <canvas id="spendingChart7d"></canvas>
      </div>
      <div style="flex:1; min-width:320px;">
        <h6>üìà Spending (30d)</h6>
        <canvas id="spendingChart30d"></canvas>
      </div>
      <div style="flex:1; min-width:320px;">
        <h6>üìà Spending (All)</h6>
        <canvas id="spendingChartAll"></canvas>
      </div>
    </div>

    <hr style="margin:18px 0;">

    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <div style="flex:1; min-width:320px;">
        <h6>‚ö† Fraud Amount (7d)</h6>
        <canvas id="fraudAmountChart7d"></canvas>
      </div>
      <div style="flex:1; min-width:320px;">
        <h6>‚ö† Fraud Amount (30d)</h6>
        <canvas id="fraudAmountChart30d"></canvas>
      </div>
      <div style="flex:1; min-width:320px;">
        <h6>‚ö† Fraud Amount (All)</h6>
        <canvas id="fraudAmountChartAll"></canvas>
      </div>
    </div>

    <hr style="margin:18px 0;">

    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
      <div style="flex:1; min-width:320px;">
        <h6>üìä Fraud Count</h6>
        <canvas id="fraudCountChartAll"></canvas>
      </div>
      <div style="width:320px;">
        <h6>Compact Fraud Breakdown</h6>
        <!-- this doughnut was missing before; JS renders into it -->
        <canvas id="fraudDoughnut" style="height:240px;"></canvas>
        <div class="text-muted small">Fraud vs Non-Fraud</div>
      </div>
    </div>
  </div>

</div> <!-- end main-content -->

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// ----------------- UI helpers -----------------
const sidebar = document.getElementById('sidebar-nav');
const menuBtn = document.getElementById('menu-toggle-btn');
menuBtn?.addEventListener('click', () => {
  sidebar.classList.toggle('collapsed');
  document.querySelector('.main-content').style.marginLeft = sidebar.classList.contains('collapsed') ? '60px' : '250px';
});

document.getElementById('transactions-menu')?.addEventListener('click', () => {
  const sub = document.getElementById('transactions-submenu');
  if (!sub) return;
  const open = sub.style.display === 'block';
  sub.style.display = open ? 'none' : 'block';
});

document.getElementById('reports-menu')?.addEventListener('click', () => {
  const sub = document.getElementById('reports-submenu');
  if (!sub) return;
  const open = sub.style.display === 'block';
  sub.style.display = open ? 'none' : 'block';
});

// graph quick links
document.querySelectorAll('.show-graph').forEach(a => {
  a.addEventListener('click', (e) => {
    e.preventDefault();
    const g = a.dataset.graph;
    if (!g) return;
    // find section and scroll
    const el = document.getElementById('graphs-area');
    if (el) el.scrollIntoView({behavior:'smooth'});
  });
});

// theme toggle
const themeToggle = document.getElementById('themeToggleBtn');
const htmlEl = document.documentElement;
(function initTheme(){
  const saved = localStorage.getItem('finsecure_theme') || 'light';
  if (saved === 'dark') document.documentElement.setAttribute('data-theme','dark');
})();
themeToggle?.addEventListener('click', () => {
  const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
  const next = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('finsecure_theme', next);
});

// ----------------- Chart utilities -----------------
let chartInstances = {};

function safeDestroy(id){
  if (chartInstances[id]) {
    try { chartInstances[id].destroy(); } catch(_) {}
    delete chartInstances[id];
  }
}

function renderChart(canvasId, config){
  try{
    const c = document.getElementById(canvasId);
    if (!c) return;
    safeDestroy(canvasId);
    chartInstances[canvasId] = new Chart(c.getContext('2d'), config);
  } catch(e){
    console.error('renderChart error', e, canvasId, config);
  }
}

function toNumberArr(arr){
  if (!Array.isArray(arr)) return [];
  return arr.map(x => {
    if (x === null || x === undefined) return 0;
    if (typeof x === 'number') return x;
    const n = parseFloat(x);
    return Number.isFinite(n) ? n : 0;
  });
}

// combine line + bar dataset helper
function makeComboConfig(labels, barData, lineData, labelName){
  return {
    type: 'bar',
    data: {
      labels: labels || [],
      datasets: [
        {
          type: 'bar',
          label: labelName + ' (bar)',
          data: toNumberArr(barData || []),
          backgroundColor: undefined, // let Chart.js default colors
          yAxisID: 'y',
        },
        {
          type: 'line',
          label: labelName + ' (trend)',
          data: toNumberArr(lineData || []),
          borderWidth: 2,
          fill: false,
          tension: 0.3,
          yAxisID: 'y',
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      stacked: false,
      scales: {
        y: { beginAtZero: true, ticks: { precision:0 } }
      },
      plugins: { legend: { position: 'top' } }
    }
  };
}

// ----------------- Fetch and render -----------------
async function fetchDashboardData(period='all'){
  document.getElementById('loader')?.classList.remove('d-none');
  try{
    const res = await fetch("{% url 'get_dashboard_data' %}?period=" + encodeURIComponent(period));
    if (!res.ok) throw new Error('Network error: ' + res.status);
    const data = await res.json();

    // Basic numeric fields
    const income = (data.income !== undefined) ? Number(data.income) : 0;
    const spending = (data.spending !== undefined) ? Number(data.spending) : 0;
    const savings = (data.savings !== undefined) ? Number(data.savings) : (income - spending);

    // Update UI
    document.getElementById('income-card') && (document.getElementById('income-card').innerText = income.toFixed(2));
    document.getElementById('income') && (document.getElementById('income').innerText = income.toFixed(2));
    document.getElementById('spending') && (document.getElementById('spending').innerText = spending.toFixed(2));
    document.getElementById('savings') && (document.getElementById('savings').innerText = savings.toFixed(2));

    // Alerts
    const alertsBox = document.getElementById('alerts');
    if (alertsBox){
      alertsBox.innerHTML = '';
      if (Array.isArray(data.alerts) && data.alerts.length){
        data.alerts.forEach(a => {
          const li = document.createElement('li');
          li.textContent = a;
          alertsBox.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.className = 'text-success';
        li.textContent = 'No unusual activity';
        alertsBox.appendChild(li);
      }
    }

    // Suggestions
    const suggestionsBox = document.getElementById('suggestions');
    if (suggestionsBox){
      // only replace if backend returned suggestions
      if (Array.isArray(data.suggestions) && data.suggestions.length){
        suggestionsBox.innerHTML = '';
        data.suggestions.forEach(s => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.style.border = 'none';
          li.textContent = (s && s.suggestion) ? s.suggestion : s;
          suggestionsBox.appendChild(li);
        });
      }
    }

    // Spending charts - try to use timeseries first
    // We'll support data.labels_7d / spending_7d etc, otherwise fallback to category_spending
    if (data.labels_7d && data.spending_7d){
      renderChart('spendingChart7d', makeComboConfig(data.labels_7d, data.spending_7d, data.spending_7d, 'Spending (7d)'));
    } else if (data.category_spending){
      const cats = data.category_spending.map(x => x.category || 'Uncategorized');
      const totals = data.category_spending.map(x => x.total || 0);
      renderChart('spendingChart7d', makeComboConfig(cats, totals, totals, 'Category (7d)'));
    } else {
      renderChart('spendingChart7d', {
        type:'bar', data:{labels:[], datasets:[]}, options:{responsive:true}
      });
    }

    if (data.labels_30d && data.spending_30d){
      renderChart('spendingChart30d', makeComboConfig(data.labels_30d, data.spending_30d, data.spending_30d, 'Spending (30d)'));
    } else {
      renderChart('spendingChart30d', { type:'bar', data:{labels:[], datasets:[]}, options:{responsive:true}});
    }

    if (data.labels_all && data.spending_all){
      renderChart('spendingChartAll', makeComboConfig(data.labels_all, data.spending_all, data.spending_all, 'Spending (All)'));
    } else if (data.category_spending){
      const cats = data.category_spending.map(x => x.category || 'Uncategorized');
      const totals = data.category_spending.map(x => x.total || 0);
      renderChart('spendingChartAll', makeComboConfig(cats, totals, totals, 'Category All'));
    } else {
      renderChart('spendingChartAll', { type:'bar', data:{labels:[], datasets:[]}, options:{responsive:true}});
    }

    // Fraud amount charts - data keys expected: fraud_7d_amount, fraud_30d_amount, fraud_all_amount
    // Use labels_7d / labels_30d / labels_all if present, otherwise generate simple labels
    const l7 = (Array.isArray(data.labels_7d) && data.labels_7d.length) ? data.labels_7d : (data.fraud_7d_amount ? data.fraud_7d_amount.map((_,i)=> `Day ${i+1}`) : []);
    const l30 = (Array.isArray(data.labels_30d) && data.labels_30d.length) ? data.labels_30d : (data.fraud_30d_amount ? data.fraud_30d_amount.map((_,i)=> `Day ${i+1}`) : []);
    const lall = (Array.isArray(data.labels_all) && data.labels_all.length) ? data.labels_all : (data.fraud_all_amount ? data.fraud_all_amount.map((_,i)=> `T${i+1}`) : []);

    renderChart('fraudAmountChart7d', {
      type:'bar',
      data:{ labels: l7, datasets:[{ label:'Fraud Amount (7d)', data: toNumberArr(data.fraud_7d_amount || []), backgroundColor: undefined }]},
      options:{ responsive:true, plugins:{ legend:{ position:'top' } }, scales:{ y:{ beginAtZero:true }}}
    });
    renderChart('fraudAmountChart30d', {
      type:'bar',
      data:{ labels: l30, datasets:[{ label:'Fraud Amount (30d)', data: toNumberArr(data.fraud_30d_amount || []), backgroundColor: undefined }]},
      options:{ responsive:true, plugins:{ legend:{ position:'top' } }, scales:{ y:{ beginAtZero:true }}}
    });
    renderChart('fraudAmountChartAll', {
      type:'bar',
      data:{ labels: lall, datasets:[{ label:'Fraud Amount (All)', data: toNumberArr(data.fraud_all_amount || []), backgroundColor: undefined }]},
      options:{ responsive:true, plugins:{ legend:{ position:'top' } }, scales:{ y:{ beginAtZero:true }}}
    });

    // Fraud count - prefer fraud_stats array: [{ is_fraud: True/False, count: N }, ...]
    let fraudCounts = [0,0]; // [fraud, nonfraud]
    if (Array.isArray(data.fraud_stats) && data.fraud_stats.length){
      const fraudRow = data.fraud_stats.find(r => String(r.is_fraud) === "True" || r.is_fraud === true) || {count:0};
      const nonRow = data.fraud_stats.find(r => String(r.is_fraud) === "False" || r.is_fraud === false) || {count:0};
      fraudCounts = [Number(fraudRow.count||0), Number(nonRow.count||0)];
    } else if (data.fraud_counts){
      // alternate format
      fraudCounts = [Number(data.fraud_counts.fraud || 0), Number(data.fraud_counts.nonfraud || 0)];
    }

    // render fraud count bar
    renderChart('fraudCountChartAll', {
      type:'bar',
      data:{
        labels: ['Fraud','Non-Fraud'],
        datasets:[{ label:'Count', data: fraudCounts }]
      },
      options:{ responsive:true, plugins:{ legend:{ position:'top' } }, scales:{ y:{ beginAtZero:true, precision:0 }}}
    });

    // Render compact doughnut
    renderChart('fraudDoughnut', {
      type:'doughnut',
      data:{
        labels:['Fraud','Non-Fraud'],
        datasets:[{ label:'Fraud Breakdown', data: fraudCounts }]
      },
      options:{ responsive:true, plugins:{ legend:{ position:'bottom' }}}
    });

  } catch (e){
    console.error('Error loading dashboard data:', e);
    const alertsBox = document.getElementById('alerts');
    if (alertsBox) alertsBox.innerHTML = '<li class="text-danger">Error loading dashboard data</li>';
  } finally {
    document.getElementById('loader')?.classList.add('d-none');
  }
}

// wire filter buttons
document.getElementById('filter7')?.addEventListener('click', ()=> fetchDashboardData('7'));
document.getElementById('filter30')?.addEventListener('click', ()=> fetchDashboardData('30'));
document.getElementById('filterAll')?.addEventListener('click', ()=> fetchDashboardData('all'));

// initial load when page ready
window.addEventListener('load', () => {
  fetchDashboardData('all');
});
</script>

{% endblock %}
