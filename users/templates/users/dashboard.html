{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
/* Navbar Override - Change to Blue */
nav.navbar,
.navbar,
header,
.top-navbar,
.main-navbar {
  background: linear-gradient(135deg, #1a5f8a 0%, #2178b5 100%) !important;
  background-color: #2178b5 !important;
}

body {
  background: linear-gradient(120deg, #e5f0fa 15%, #c8e2f7 92%);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
}
.sidebar-nav {
  position: fixed;
  top: 0; left: 0; bottom: 0;
  width: 250px; /* Full width always */
  background: #0f5279;
  box-shadow: 2px 0 16px #79b4e060;
  z-index: 1100;
  display: flex;
  flex-direction: column;
  transition: width .20s cubic-bezier(.4,2,.6,1);

}
.sidebar-nav.expanded { width: 250px; }
.menu-toggle-btn {
  background: none;
  border: none;
  color: #e1f4ff;
  font-size: 2rem;
  padding: 24px 0 19px 0;
  text-align: center;
  cursor: pointer;
  outline: none;
  margin-bottom: 4px;
  display: block;
}


.sidebar-brand {
  color: #e1f4ff;
  font-weight: bold;
  font-size: 1.3rem;
  text-align: center;
  letter-spacing: .6px;
  padding:  0 0 13px 0;
  white-space:nowrap;
  opacity: 0;
  height:0;
  transition: opacity .18s, height .18s;

}
.sidebar-nav.expanded .sidebar-brand { opacity:1; height:auto; padding-top:25px;}
.sidebar-menu {
  flex: 1; margin-top: 0;
  display: flex; flex-direction: column;
}
.sidebar-menu a,
.sidebar-menu .submenu-toggle {
  display: flex; align-items: center;
  font-size: 0;
  font-weight: 500;
  color: #e0f3ff;
  padding: 16px 20px 16px 20px;
  text-decoration: none;
  border-left: 5px solid transparent;
  transition: background .14s, color .14s, border-color .2s, font-size .18s, padding .18s;
  border-radius: 6px 0 0 6px;
  margin-bottom: 2px;
  cursor: pointer;
  background: none;
  border: none;
  outline: none;
}


.sidebar-menu a .bi,
.sidebar-menu .submenu-toggle .bi { margin-right: 0; font-size: 1.26em;}
.sidebar-menu a.active, .sidebar-menu a:hover,
.sidebar-menu .submenu-toggle.active, .sidebar-menu .submenu-toggle:hover {
  background: #2178b5;
  color: #fff;
  border-left: 5px solid #80c2fa;
}

.sidebar-menu a span,
.sidebar-menu .submenu-toggle span {
  margin-left: 8px;
  white-space:nowrap;
  transition: opacity .17s;
  opacity:0;
  pointer-events:none;
  font-size: 1.02em;
}



.sidebar-nav.expanded .sidebar-menu a,
.sidebar-nav.expanded .sidebar-menu .submenu-toggle{
  font-size: 1.07rem;
  padding: 14px 32px 14px 26px;
}
.sidebar-nav.expanded .sidebar-menu a span,
.sidebar-nav.expanded .sidebar-menu .submenu-toggle span {
  opacity:1; pointer-events:auto;
}

/* Submenu styles */
.sidebar-menu .submenu {
  max-height: 0;
  overflow: hidden;
  background: #165e88;
  transition: max-height 0.27s cubic-bezier(.4,2,.6,1);
  margin-left: 0;
  padding-left: 0;
}
.sidebar-menu .submenu.open {
  max-height: 180px;
}
.sidebar-menu .submenu a {
  font-size: 0;
  padding: 14px 32px 14px 56px;
  border-radius: 6px 0 0 6px;
  border-left: 3px solid #0f5279 !important;
  color: #cbe8fc;
  background: none;
  margin-bottom: 0;
}
.sidebar-nav.expanded .sidebar-menu .submenu a {
  font-size: 1rem;
}
.sidebar-menu .submenu a.active, .sidebar-menu .submenu a:hover {
  background: #2178b5;
  color: #fff;
  border-left: 3px solid #80c2fa !important;
}
.sidebar-menu .submenu-arrow {
  margin-left: auto;
  transition: transform 0.2s;
}
.sidebar-menu .submenu-toggle[aria-expanded="true"] .submenu-arrow {
  transform: rotate(90deg);
}


.sidebar-footer {
  text-align: center;
  padding: 12px 0 0 0;
  color: #9ccfe7;
  font-size: 0.99rem;
}

.main-content {
  margin-left: 250px;
  padding: 32px 36px 32px 36px;
  min-height: 100vh;
  transition: margin-left .20s cubic-bezier(.4,2,.6,1);

}
.sidebar-nav.expanded ~ .main-content {
  margin-left: 250px;
}



/* Top Card: Welcome/Profile */
.dashboard-header-card {
  max-width: 950px;
  margin: 0 auto 28px auto;
  background: linear-gradient(95deg, #f3f9fe 87%, #ddedfb 100%);
  border-radius: 20px;
  box-shadow: 0 4px 28px #77a8db17;
  padding: 28px 32px 18px 32px;
  display: flex; flex-direction:column;
}
.profile-card {
  display: flex; flex-direction: column; gap:8px;
}
.profile-header {
  display: flex;
  align-items: center;
  gap: 18px;
}
.profile-header img {
  border-radius: 50%;
  width: 68px;
  height: 68px;
  object-fit: cover;
  border: 3px solid #cbe9f7;
}
.profile-details { margin-top: 14px; }
.profile-details p { margin: 5px 0; color: #2372a7;}
.dashboard-header-card hr {margin:10px 0 6px 0;}
.dashboard-card {
  background: linear-gradient(135deg, #f9fcfe 98%, #dcedf7 100%);
  border-radius: 17px;
  box-shadow: 0 7px 19px #9dd1e814, 0 1px 10px #60aee410;
  padding: 20px 24px 18px 24px;
  margin-bottom: 22px;
}
.card-header.bg-primary {
  background: #2178b5 !important;
  color: #fff !important;
}
.card-header.bg-warning { background: #def1ff !important; color: #2178b5 !important; }
.card-header.bg-success { background: #94d7c4 !important; color: #24705b !important; }
.card-header.bg-info { background: #e4f2fa !important; color: #3082b7 !important; }
.card-header.bg-dark { background: #256a92 !important; color: #fff !important; }
.card-header { font-weight: bold; padding: 0.8em 1.3em; border-radius: 12px 12px 0 0;}
.btn-primary, .btn-outline-primary {
  background-color: #2178b5 !important;
  border-color: #bee5fd !important; color: #fff;
}
.btn-primary:hover, .btn-outline-primary:hover {
  background-color: #329ae6 !important; border-color: #2178b5 !important;
}
.btn-success, .btn-outline-success { background-color: #36a397 !important; border-color: #4bc8b7 !important; color: #fff;}
.btn-success:hover, .btn-outline-success:hover { background-color: #1d867e !important; border-color: #36a397 !important;}
.btn-warning, .btn-outline-warning { background-color: #f3f9fe !important; color: #2178b5 !important; border-color: #c2e5ff !important;}
.btn-info, .btn-outline-info { background-color: #e4f2fa !important; color: #2178b5 !important; border-color: #a9cadd !important;}
.btn-danger, .btn-outline-danger { background-color: #be6c91 !important; color: #fff !important; border-color: #9c3d65 !important;}
.btn { border-radius: 8px; }

.graph-section { display: none; }
.graph-section.active { display: block; }

/* For vertical submenu under Reports (inherits your existing sidebar style) */
.sidebar-menu .submenu-vertical {
  display: none;
  background: #165e88;
  margin-left: 0;
  border-radius: 6px 0 0 6px;
  padding: 0;
}
.sidebar-menu .submenu-vertical.open { display: block; }
.sidebar-menu .submenu-vertical a {
  display: flex;
  align-items: center;
  color: #e0f3ff;
  font-size: 1rem;
  padding: 14px 32px 14px 56px;
  border-radius: 6px 0 0 6px;
  border-left: 3px solid #0f5279 !important;
  background: none;
  margin-bottom: 0;
  text-decoration: none;
  transition: background .14s, color .14s, border-color .2s;
}
.sidebar-menu .submenu-vertical a.active, .sidebar-menu .submenu-vertical a:hover {
  background: #2178b5;
  color: #fff;
  border-left: 3px solid #80c2fa !important;
}
.sidebar-menu .submenu-vertical .bi {
  margin-right: 10px;
  font-size: 1.18em;
}
</style>

<!-- Sidebar Navigation -->
<nav class="sidebar-nav" aria-label="Side Navigation" id="sidebar-nav">
  <button class="menu-toggle-btn" id="menu-toggle-btn" aria-label="Expand/collapse sidebar">
    <i class="bi bi-list"></i>
  </button>

  <div class="sidebar-brand">FinSecure</div>
  <div class="sidebar-menu">
    <a href="{% url 'dashboard' %}" class="active"><i class="bi bi-house-door-fill"></i><span>Dashboard</span></a>
    <div>
      <button class="submenu-toggle" id="transactions-menu" aria-expanded="false">
        <i class="bi bi-cash-coin"></i><span>Transactions</span>
        <span class="submenu-arrow bi bi-chevron-right"></span>
      </button>
      <div class="submenu" id="transactions-submenu">
        <a href="{% url 'transactions:add' %}"><i class="bi bi-plus-circle"></i><span>Add Transaction</span></a>
        <a href="{% url 'transactions:list' %}"><i class="bi bi-list-ul"></i><span>View All</span></a>
      </div>
    </div>

    <a href="{% url 'fraud_alerts' %}"><i class="bi bi-exclamation-triangle"></i><span>Fraud Alerts</span></a>
    <button class="submenu-toggle" id="reports-menu" aria-expanded="false">

        <i class="bi bi-bar-chart-line"></i><span>Reports</span>
        <span class="submenu-arrow bi bi-chevron-right"></span>
      </button>
      <div class="submenu-vertical" id="reports-submenu">
        <a href="#" class="show-graph" data-graph="spending"><i class="bi bi-graph-up"></i>Spending Graphs</a>
        <a href="#" class="show-graph" data-graph="fraud-amount"><i class="bi bi-exclamation-diamond"></i>Fraud Amount</a>
        <a href="#" class="show-graph" data-graph="fraud-count"><i class="bi bi-bar-chart"></i>Fraud Count</a>
      </div>
    <a href="{% url 'settings' %}"><i class="bi bi-gear"></i><span>Settings</span></a>
  </div>
  <div class="sidebar-footer">Â© {{ now|date:"Y" }} FinSecure</div>
</nav>

<!-- Main Content -->
<div class="main-content">
  <!-- Loader -->
  <div id="loader" class="loader-overlay d-none">
    <div class="spinner-border text-primary" role="status"></div>
    <span class="ms-2">Loading...</span>
  </div>

  <!-- User Profile Card (Enhanced) -->
  <div class="dashboard-header-card">
    <div class="profile-card">
      <div class="profile-header">
        {% if user.profile.profile_photo %}
          <img src="{{ user.profile.profile_photo.url }}" alt="{{ user.username }} Profile">
        {% else %}
          <img src="{% static 'images/default-profile.png' %}" alt="Default Profile">
        {% endif %}
        <div>
          <h2>Welcome, {{ user.get_full_name|default:user.username }} ðŸ‘‹</h2>
          <p>Your personalized financial dashboard</p>
        </div>
      </div>
      <hr>
      <div class="profile-details">
        <p><strong>ðŸ“§ Email:</strong> {{ user.email }}</p>
        <p><strong>ðŸ“ž Phone:</strong> {{ user.profile.phone|default:"Not set" }}</p>
        <p><strong>ðŸ’¼ Occupation:</strong> {{ user.profile.occupation|default:"Not set" }}</p>
        <p><strong>ðŸ’° Income:</strong> â‚¹<span id="income">{{ income|default:user.profile.income|default:"0.00"|floatformat:2 }}</span></p>
      </div>
      <div style="margin-top: 15px;">
        <a href="{% url 'profile' %}" class="btn btn-primary btn-sm"><i class="bi bi-pencil"></i> Update Profile</a>
        {% if gmail_connected %}
          <span class="badge bg-success ms-2"><i class="bi bi-check-circle"></i> Gmail Connected</span>
        {% else %}
          <a href="{% url 'connect_gmail' %}" class="btn btn-danger btn-sm ms-2"><i class="bi bi-envelope"></i> Connect Gmail</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Featured Widgets -->
  <div class="dashboard-card">
    <div class="row gx-3">
      <div class="col-md-4 mb-3">
        <div class="card h-100 p-2 shadow-sm">
          <div class="card-header bg-warning text-dark fw-bold">Financial Assistance</div>
          <div class="card-body text-center">
            <a href="{% url 'assist_home_home' %}" class="btn btn-warning btn-lg">ðŸ’µ Financial Assistance</a>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card h-100 p-2 shadow-sm">
          <div class="card-header bg-dark text-white">Transactions</div>
          <div class="card-body d-flex flex-column justify-content-center align-items-center">
            <a href="{% url 'transactions:add' %}" class="btn btn-success btn-sm mb-2">Add Transaction</a>
            
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card h-100 p-2 shadow-sm">
          <div class="card-header bg-success text-white">Smart Suggestions</div>
          <div class="card-body">
            <ul id="suggestions" class="list-group list-group-flush">
              {% if suggestions %}
                {% for s in suggestions %}
                  <li class="list-group-item d-flex align-items-center {% if s.is_alert %}alert{% endif %}">
                    {% if s.is_alert %}
                      <span class="me-2 text-danger fw-bold">âš </span>
                    {% else %}
                      <span class="me-2 text-success">ðŸ’¡</span>
                    {% endif %}
                    <span>{{ s.suggestion }}</span>
                    <small class="text-muted ms-auto">{{ s.created_at|date:"M d, Y H:i" }}</small>
                  </li>
                {% endfor %}
              {% else %}
                <li class="text-muted">No suggestions available.</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Gmail Transactions Table -->
    <div class="card shadow-sm mt-4">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">ðŸ’° Recent Gmail Transactions</h5>
      </div>
      <div class="card-body">
        {% if transactions %}
        <div class="table-responsive">
          <table class="table table-striped table-hover gmail-txns align-middle">
            <thead>
              <tr>
                <th>Description</th>
                <th>Amount</th>
                <th>Currency</th>
                <th>Email</th>
              </tr>
            </thead>
            <tbody>
              {% for txn in transactions %}
              <tr>
                <td>{{ txn.description }}</td>
                <td>{{ txn.amount }}</td>
                <td>{{ txn.currency }}</td>
                <td>
                  <a href="https://mail.google.com/mail/u/0/#inbox/{{ txn.message_id }}" 
                     target="_blank" 
                     class="btn btn-sm btn-outline-primary">
                     ðŸ“§ View Email
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted">No Gmail transactions found.</p>
        {% endif %}
      </div>
    </div>

    <!-- Latest Emails -->
    <div class="row gx-3 mt-4">
      <div class="col-md-12 mb-3">
        <div class="card h-100 p-2 shadow-sm">
          <div class="card-header bg-info text-white">ðŸ“§ Latest Emails</div>
          <div class="card-body">
            {% if latest_emails %}
              <ul class="list-group list-group-flush">
                {% for email in latest_emails %}
                  <li class="list-group-item">
                    <strong>From:</strong> {{ email.from }}<br>
                    <strong>Subject:</strong> {{ email.subject }}<br>
                    <small>{{ email.snippet }}</small>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">
                {% if gmail_connected %}
                  No recent emails found.
                {% else %}
                  Please connect Gmail to see emails.
                {% endif %}
              </p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Financial Health Summary -->
  <div class="dashboard-card">
    <div class="card-header bg-warning d-flex justify-content-between align-items-center">
      <span class="fw-bold">ðŸ“Š Financial Health Summary</span>
      <div>
        <button id="filter7" class="btn btn-sm btn-outline-primary">Last 7 Days</button>
        <button id="filter30" class="btn btn-sm btn-outline-success">Last 30 Days</button>
        <button id="filterAll" class="btn btn-sm btn-outline-primary">All Time</button>
      </div>
    </div>
    <div class="row text-center mt-3 mb-2">
      <div class="col-md-3 border-end">
        <h6>Income</h6>
        <p class="text-success fw-bold">â‚¹<span id="income-card">{{ income|default:"0.00"|floatformat:2 }}</span></p>
      </div>
      <div class="col-md-3 border-end">
        <h6>Spending</h6>
        <p class="text-danger fw-bold">â‚¹<span id="spending">{{ spending|default:"0.00"|floatformat:2 }}</span></p>
      </div>
      <div class="col-md-3 border-end">
        <h6>Savings</h6>
        <p class="text-primary fw-bold">â‚¹<span id="savings">{{ savings|default:"0.00"|floatformat:2 }}</span></p>
      </div>
      <div class="col-md-3">
        <h6>Alerts</h6>
        <ul id="alerts" class="list-unstyled text-danger small">
          {% for alert in alerts %}
            <li>ðŸ”” {{ alert }}</li>
          {% empty %}
            <li class="text-success">No unusual activity</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Spending Graphs -->
  <div id="spending-graph-section" class="graph-section"></div>
  <div class="dashboard-card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center toggle-collapse"
         data-bs-toggle="collapse" data-bs-target="#spendingGraphs" style="cursor:pointer;">
      <span>ðŸ“ˆ Spending Graphs</span>
      <span class="arrow">â–¼</span>
    </div>
    <div id="spendingGraphs" class="collapse">
      <div class="row mt-4 mb-2">
        <div class="col-md-4 mb-2"><h6>Spending (7 Days)</h6><canvas id="spendingChart7d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Spending (30 Days)</h6><canvas id="spendingChart30d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Spending (All Time)</h6><canvas id="spendingChartAll"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Fraud Amount Graphs -->
  <div id="fraud-amount-graph-section" class="graph-section"></div>
  <div class="dashboard-card">
    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center toggle-collapse"
         data-bs-toggle="collapse" data-bs-target="#fraudAmountGraphs" style="cursor:pointer;">
      <span>âš  Fraud Amount Graphs</span>
      <span class="arrow">â–¼</span>
    </div>
    <div id="fraudAmountGraphs" class="collapse">
      <div class="row mt-4 mb-2">
        <div class="col-md-4 mb-2"><h6>Fraud Amount (7 Days)</h6><canvas id="fraudAmountChart7d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Fraud Amount (30 Days)</h6><canvas id="fraudAmountChart30d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Fraud Amount (All Time)</h6><canvas id="fraudAmountChartAll"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Fraud Count Graphs -->
  <div id="fraud-count-graph-section" class="graph-section"></div>
  <div class="dashboard-card">
    <div class="card-header bg-warning d-flex justify-content-between align-items-center toggle-collapse"
         data-bs-toggle="collapse" data-bs-target="#fraudCountGraphs" style="cursor:pointer;">
      <span>ðŸ“Š Fraud Count Graphs</span>
      <span class="arrow">â–¼</span>
    </div>
    <div id="fraudCountGraphs" class="collapse">
      <div class="row mt-4 mb-2">
        <div class="col-md-4 mb-2"><h6>Fraud Count (7 Days)</h6><canvas id="fraudCountChart7d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Fraud Count (30 Days)</h6><canvas id="fraudCountChart30d"></canvas></div>
        <div class="col-md-4 mb-2"><h6>Fraud Count (All Time)</h6><canvas id="fraudCountChartAll"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Hamburger Sidebar Toggle
  const sidebar = document.getElementById('sidebar-nav');
  const toggleBtn = document.getElementById('menu-toggle-btn');
  toggleBtn.onclick = function() {
    sidebar.classList.toggle('expanded');
    if (sidebar.classList.contains('expanded')) {
      document.querySelector('.main-content').style.marginLeft = "250px";
    } else {
      document.querySelector('.main-content').style.marginLeft = "60px";
    }
  };

  // Transactions submenu toggle
  const submenuToggle = document.getElementById('transactions-menu');
  const submenu = document.getElementById('transactions-submenu');
  submenuToggle.onclick = function() {
    const expanded = submenuToggle.getAttribute('aria-expanded') === 'true';
    submenuToggle.setAttribute('aria-expanded', !expanded);
    submenu.classList.toggle('open');
  };
  

   // Reports submenu vertical toggle
  const reportsToggle = document.getElementById('reports-menu');
  const reportsMenu = document.getElementById('reports-submenu');
  reportsToggle.onclick = function() {
    const expanded = reportsToggle.getAttribute('aria-expanded') === 'true';
    reportsToggle.setAttribute('aria-expanded', !expanded);
    reportsMenu.classList.toggle('open');
  };
  // Show correct graph section
  document.querySelectorAll('.show-graph').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('.graph-section').forEach(sec => sec.classList.remove('active'));
      if (this.dataset.graph === 'spending')
        document.getElementById('spending-graph-section').classList.add('active');
      if (this.dataset.graph === 'fraud-amount')
        document.getElementById('fraud-amount-graph-section').classList.add('active');
      if (this.dataset.graph === 'fraud-count')
        document.getElementById('fraud-count-graph-section').classList.add('active');
      reportsMenu.classList.remove('open');
      reportsToggle.setAttribute('aria-expanded', 'false');
      setTimeout(() => {
        let visible = document.querySelector('.graph-section.active');
        if (visible) visible.scrollIntoView({behavior: "smooth"});
      }, 100);
    });
  });


  let chartInstances = {};
  let selectedPeriod = "all";
  function renderChart(canvasId, labels, dataArr, labelName, color, type="line") {
    if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
    const ctx = document.getElementById(canvasId).getContext("2d");
    chartInstances[canvasId] = new Chart(ctx, {
      type: type,
      data: { labels: labels, datasets: [{
        label: labelName,
        data: dataArr,
        borderColor: color,
        backgroundColor: type === "line" ? color + "33" : color,
        fill: type === "line",
        tension: 0.3
      }] },
      options: { responsive: true, plugins: { legend: { position: "top" } } }
    });
  }
  function fetchDashboardData(period = "all") {
    selectedPeriod = period;
    document.getElementById("loader").classList.remove("d-none");
    fetch({% url 'dashboard_data' %}?period=${period})
      .then(response => response.json())
      .then(data => {
        document.getElementById('income-card').innerText = data.income.toFixed(2);
        document.getElementById('spending').innerText = data.spending.toFixed(2);
        document.getElementById('savings').innerText = data.savings.toFixed(2);
        // Alerts
        const alertsBox = document.getElementById("alerts");
        alertsBox.innerHTML = "";
        if (data.alerts.length) {
          data.alerts.forEach(a => alertsBox.innerHTML += '<li>ðŸ”” ${a}</li>');
        } else {
          alertsBox.innerHTML = '<li class="text-success">No unusual activity</li>';
        }
        // Suggestions
        const suggestionsBox = document.getElementById("suggestions");
        suggestionsBox.innerHTML = "";
        if (data.suggestions.length) {
          data.suggestions.forEach(s => suggestionsBox.innerHTML += '<li class="list-group-item">ðŸ’¡ ${s}</li>');
        } else {
          suggestionsBox.innerHTML = '<li class="list-group-item">No suggestions available.</li>';
        }
        renderChart("spendingChart7d", data.labels_7d, data.spending_7d, "Spending (7d)", "#b67ee6");
        renderChart("spendingChart30d", data.labels_30d, data.spending_30d, "Spending (30d)", "#993fc7");
        renderChart("spendingChartAll", data.labels_all, data.spending_all, "Spending (All)", "#a459c8");
        renderChart("fraudAmountChart7d", data.labels_7d, data.fraud_7d_amount, "Fraud Amount (7d)", "#d36bea", "bar");
        renderChart("fraudAmountChart30d", data.labels_30d, data.fraud_30d_amount, "Fraud Amount (30d)", "#8d53c9", "bar");
        renderChart("fraudAmountChartAll", data.labels_all, data.fraud_all_amount, "Fraud Amount (All)", "#b67ee6", "bar");
        renderChart("fraudCountChart7d", data.labels_7d, data.fraud_7d_count, "Fraud Count (7d)", "#c992e0", "bar");
        renderChart("fraudCountChart30d", data.labels_30d, data.fraud_30d_count, "Fraud Count (30d)", "#993fc7", "bar");
        renderChart("fraudCountChartAll", data.labels_all, data.fraud_all_count, "Fraud Count (All)", "#e9bafd", "bar");
      })
      .finally(() => document.getElementById("loader").classList.add("d-none"));
  }
  document.getElementById("filter7").addEventListener("click", () => fetchDashboardData("7"));
  document.getElementById("filter30").addEventListener("click", () => fetchDashboardData("30"));
  document.getElementById("filterAll").addEventListener("click", () => fetchDashboardData("all"));
  window.onload = () => fetchDashboardData("all");
  document.querySelectorAll(".toggle-collapse").forEach(header => {
    const arrow = header.querySelector(".arrow");
    const targetId = header.getAttribute("data-bs-target");
    const target = document.querySelector(targetId);
    target.addEventListener("show.bs.collapse", () => arrow.textContent = "â–²");
    target.addEventListener("hide.bs.collapse", () => arrow.textContent = "â–¼");
  });
</script>
{% endblock %}
